+++
title = "k8s practice"
description = "the way to kubernetes"
tags = [
    "kubernetes",
    "k8s"
]
date = "2020-08-23"
topics = [
    "kubernetes",
    "k8s"
]
draft = false
toc = true
+++

### ÊúØËØ≠ÂàóË°®


{{< fluid_imgs
  "pure-u-1-1|https://static001.geekbang.org/resource/image/8e/67/8ee9f2fa987eccb490cfaa91c6484f67.png|KubernetesÈ°πÁõÆÊû∂ÊûÑ|https://time.geekbang.org/column/article/23132"
>}}

- OCI: Open Container Initiative
- CNI: Container Network Interface
- CRI: Container Runtime Interface
- CSI: Container Storage Interface

‰ΩøÁî®ÁéØÂ¢ÉWindows„ÄÇ

### WSL2 + Kubernetes

[Âú® Windows ‰∏ã‰ΩøÁî® WSL2 Êê≠Âª∫ Kubernetes ÈõÜÁæ§](https://www.qikqiak.com/post/deploy-k8s-on-win-use-wsl2)

- ÂÆâË£ÖÂïÜÂ∫óÈáåÁöÑ`windows terminal`
- Êõ¥Êñ∞ubuntuÁöÑËΩØ‰ª∂Ê∫ê

```
cp /etc/apt/sources.list /etc/apt/sources.list.bak
root@k8s:~# echo "deb http://mirrors.aliyun.com/ubuntu/ focal main restricted
deb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted
deb http://mirrors.aliyun.com/ubuntu/ focal universe
deb http://mirrors.aliyun.com/ubuntu/ focal-updates universe
deb http://mirrors.aliyun.com/ubuntu/ focal multiverse
deb http://mirrors.aliyun.com/ubuntu/ focal-updates multiverse
deb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted
deb http://mirrors.aliyun.com/ubuntu/ focal-security universe
deb http://mirrors.aliyun.com/ubuntu/ focal-security multiverse" > /etc/apt/sources.list
```

- kindÂèØ‰ª•‰ªégithub‰∏ä‰∏ãËΩΩÂêéÊâãÂä®ÂÆâË£Ö‚Äî‚ÄîÊú¨Ë∫´ÊòØgoÁºñËØëÁöÑ‰∫åËøõÂà∂Êñá‰ª∂
- ‰ΩÜkindÂÆâË£ÖkubernetesÈõÜÁæ§Êó∂‰ΩøÁî®ÁöÑÊòØÁºñËØëÂèëÂ∏ÉÂú®hub.docker.com‰∏äÁöÑÈïúÂÉèÔºåWSL2ÈáåÈÅáÂà∞ÁΩëÁªúÈóÆÈ¢ò

>This will bootstrap a Kubernetes cluster using a pre-built¬†[node image](https://kind.sigs.k8s.io/docs/design/node-image). Prebuilt images are hosted at[`kindest/node`](https://hub.docker.com/r/kindest/node/)

```
root@Gebitang:/home/geb# kind create cluster --name wslk8s
Creating cluster "wslk8s" ...
 ‚úì Ensuring node image (kindest/node:v1.21.1) üñº
 ‚úì Preparing nodes üì¶
 ‚úì Writing configuration üìú
 ‚úì Starting control-plane üïπÔ∏è
 ‚úì Installing CNI üîå
 ‚úì Installing StorageClass üíæ
Set kubectl context to "kind-wslk8s"
You can now use your cluster with:

kubectl cluster-info --context kind-wslk8s

Thanks for using kind! üòä
```

ÈáçÊñ∞‰ΩøÁî®`kubeadm`ËøõË°åÂÆâË£ÖÔºö

- ÈúÄË¶ÅÂÖàÂ∞Üapt-key.gpgËØÅ‰π¶ÂØºÂÖ•`curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -`„ÄÇÂèØ‰ª•ÂÖàÂ∞ÜÊñá‰ª∂‰∏ãËΩΩÂà∞Êú¨Âú∞ÔºåÁÑ∂Âêé`cat apt-get.gpg | apt-key add -`
- Ê∑ªÂä†ÈïúÂÉèÊ∫êÂà∞ÂàóË°®ÔºöÂú®`/etc/apt/sources.list.d/`ÁõÆÂΩï‰∏ãÂàõÂª∫`kubernetes.list`Êñá‰ª∂ÔºåÂÜÖÂÆπ‰∏∫`deb http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial main`
- ÊâßË°å`apt-get update && apt-get install -y kubeadm`

ÊâßË°å`kubeadm version`ËøîÂõû‰ø°ÊÅØ„ÄÇ

### Errors were encountered while processing:  ubuntu-advantage-tools

ubuntu20.04ÊâßË°å`apt-get upgrade`Êó∂ÈÅáÂà∞Á±ª‰ºº‰∏äÈù¢ÁöÑÈóÆÈ¢òÔºåÁúãËµ∑Êù•ÊòØ‰∏™[bug](https://bugs.launchpad.net/ubuntu/+source/ubuntu-advantage-tools/+bug/1938097)ÔºåÂÆòÊñπÊèêÁ§∫‰øÆÂ§çÊñπÂºèÔºö

- ÁºñËæë`/var/lib/dpkg/info/ubuntu-advantage-tools.postinst`
- ÊâßË°å`dpkg --configure -a`
```
I think the problem is in the postinst script, line 295:

    cloud_id=""
    if command -v "cloud-id" > /dev/null ; then
      cloud_id=$(cloud-id)
    fi

The third line should rather be:

      cloud_id=$(cloud-id || true)
```


Ê†πÊçÆ[‰∫ëÂéüÁîüÊäÄÊúØÂü∫Á°Ä](https://edu.aliyun.com/roadmap/cloudnative)ÁöÑ[Á¨¨‰∏âËØæÁöÑdemo](https://edu.aliyun.com/lesson_1651_16894)

### ÂâçÊèêÁéØÂ¢É

‰∏â‰ª∂Â•óÔºöVirturalBox„ÄÅkubectl„ÄÅminikube„ÄÇ

- ÂÆâË£Ö VirtualBoxÔºö¬†[https://www.virtualbox.org/wiki/Downloads](https://www.virtualbox.org/wiki/Downloads)

- ÂÆâË£Ö[kubectl on windows](https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-on-windows)

‰∏ãËΩΩ„ÄÅÊ∑ªÂä†PATH„ÄÅÈ™åËØÅÁâàÊú¨

1.  Download the latest release v1.18.0 from¬†[this link](https://storage.googleapis.com/kubernetes-release/release/v1.18.0/bin/windows/amd64/kubectl.exe).

    Or if you have¬†`curl`¬†installed, use this command:

    ```
    curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.18.0/bin/windows/amd64/kubectl.exe
    ```

    To find out the latest stable version (for example, for scripting), take a look at¬†[https://storage.googleapis.com/kubernetes-release/release/stable.txt](https://storage.googleapis.com/kubernetes-release/release/stable.txt).

2.  Add the binary in to your PATH.

3.  Test to ensure the version of¬†`kubectl`¬†is the same as downloaded:

    ```
    kubectl version --client
    ```


- ÂÆâË£ÖminikubeÔºå[ÂéüÁîüÂÆâË£Ö](https://kubernetes.io/docs/tasks/tools/install-minikube/)Ôºå[aliyun: Minikube - KubernetesÊú¨Âú∞ÂÆûÈ™åÁéØÂ¢É](https://developer.aliyun.com/article/221687)

ÂÖàËøõË°åÁ≥ªÁªüÊ£ÄÊµã`systeminfo` 

```
Hyper-V Requirements:     A hypervisor has been detected. Features required for Hyper-V will not be displayed.
Hyper-V Ë¶ÅÊ±Ç:     Â∑≤Ê£ÄÊµãÂà∞ËôöÊãüÊú∫ÁõëÊéßÁ®ãÂ∫è„ÄÇÂ∞Ü‰∏çÊòæÁ§∫ Hyper-V ÊâÄÈúÄÁöÑÂäüËÉΩ„ÄÇ
```

---

ÂêØÂä®ÂëΩ‰ª§Ôºö `minikube start --driver virtualbox`
```
D:\>minikube start --driver=virtualbox
* Microsoft Windows 10 Education 10.0.18363 Build 18363 ‰∏äÁöÑ minikube v1.12.3
* Ê†πÊçÆÁé∞ÊúâÁöÑÈÖçÁΩÆÊñá‰ª∂‰ΩøÁî® virtualbox È©±Âä®Á®ãÂ∫è
* Starting control plane node minikube in cluster minikube
* Creating virtualbox VM (CPUs=4, Memory=6000MB, Disk=20000MB) ...
! StartHost failed, but will try again: creating host: create: precreate: This computer is running Hyper-V. VirtualBox won't boot a 64bits VM when Hyper-V is activated. Either use Hyper-V as a driver, or disable the Hyper-V hypervisor. (To skip this check, use --virtualbox-no-vtx-check)
* Creating virtualbox VM (CPUs=4, Memory=6000MB, Disk=20000MB) ...
* Failed to start virtualbox VM. "minikube start" may fix it: creating host: create: precreate: This computer is running Hyper-V. VirtualBox won't boot a 64bits VM when Hyper-V is activated. Either use Hyper-V as a driver, or disable the Hyper-V hypervisor. (To skip this check, use --virtualbox-no-vtx-check)
*
E0821 17:24:38.091674   11324 exit.go:76] &{ID:VBOX_HYPERV_64_BOOT Err:This computer is running Hyper-V. VirtualBox won't boot a 64bits VM when Hyper-V is activated. Either use Hyper-V as a driver, or disable the Hyper-V hypervisor. (To skip this check, use --virtualbox-no-vtx-check)
precreate
k8s.io/minikube/pkg/minikube/machine.(*LocalClient).Create
        /app/pkg/minikube/machine/client.go:225
k8s.io/minikube/pkg/minikube/machine.timedCreateHost.func2
        /app/pkg/minikube/machine/start.go:188
runtime.goexit
        /usr/local/go/src/runtime/asm_amd64.s:1373
create
k8s.io/minikube/pkg/minikube/machine.timedCreateHost
        /app/pkg/minikube/machine/start.go:197
k8s.io/minikube/pkg/minikube/machine.createHost
        /app/pkg/minikube/machine/start.go:163
k8s.io/minikube/pkg/minikube/machine.StartHost
        /app/pkg/minikube/machine/start.go:86
k8s.io/minikube/pkg/minikube/node.startHost
        /app/pkg/minikube/node/start.go:401
k8s.io/minikube/pkg/minikube/node.startMachine
        /app/pkg/minikube/node/start.go:345
k8s.io/minikube/pkg/minikube/node.Provision
        /app/pkg/minikube/node/start.go:234
k8s.io/minikube/cmd/minikube/cmd.provisionWithDriver
        /app/cmd/minikube/cmd/start.go:275
k8s.io/minikube/cmd/minikube/cmd.runStart
        /app/cmd/minikube/cmd/start.go:169
github.com/spf13/cobra.(*Command).execute
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:846
github.com/spf13/cobra.(*Command).ExecuteC
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:950
github.com/spf13/cobra.(*Command).Execute
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:887
k8s.io/minikube/cmd/minikube/cmd.Execute
        /app/cmd/minikube/cmd/root.go:106
main.main
        /app/cmd/minikube/main.go:71
runtime.main
        /usr/local/go/src/runtime/proc.go:203
runtime.goexit
        /usr/local/go/src/runtime/asm_amd64.s:1373
creating host
k8s.io/minikube/pkg/minikube/machine.createHost
        /app/pkg/minikube/machine/start.go:164
k8s.io/minikube/pkg/minikube/machine.StartHost
        /app/pkg/minikube/machine/start.go:86
k8s.io/minikube/pkg/minikube/node.startHost
        /app/pkg/minikube/node/start.go:401
k8s.io/minikube/pkg/minikube/node.startMachine
        /app/pkg/minikube/node/start.go:345
k8s.io/minikube/pkg/minikube/node.Provision
        /app/pkg/minikube/node/start.go:234
k8s.io/minikube/cmd/minikube/cmd.provisionWithDriver
        /app/cmd/minikube/cmd/start.go:275
k8s.io/minikube/cmd/minikube/cmd.runStart
        /app/cmd/minikube/cmd/start.go:169
github.com/spf13/cobra.(*Command).execute
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:846
github.com/spf13/cobra.(*Command).ExecuteC
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:950
github.com/spf13/cobra.(*Command).Execute
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:887
k8s.io/minikube/cmd/minikube/cmd.Execute
        /app/cmd/minikube/cmd/root.go:106
main.main
        /app/cmd/minikube/main.go:71
runtime.main
        /usr/local/go/src/runtime/proc.go:203
runtime.goexit
        /usr/local/go/src/runtime/asm_amd64.s:1373
Failed to start host
k8s.io/minikube/pkg/minikube/node.startMachine
        /app/pkg/minikube/node/start.go:347
k8s.io/minikube/pkg/minikube/node.Provision
        /app/pkg/minikube/node/start.go:234
k8s.io/minikube/cmd/minikube/cmd.provisionWithDriver
        /app/cmd/minikube/cmd/start.go:275
k8s.io/minikube/cmd/minikube/cmd.runStart
        /app/cmd/minikube/cmd/start.go:169
github.com/spf13/cobra.(*Command).execute
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:846
github.com/spf13/cobra.(*Command).ExecuteC
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:950
github.com/spf13/cobra.(*Command).Execute
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:887
k8s.io/minikube/cmd/minikube/cmd.Execute
        /app/cmd/minikube/cmd/root.go:106
main.main
        /app/cmd/minikube/main.go:71
runtime.main
        /usr/local/go/src/runtime/proc.go:203
runtime.goexit
        /usr/local/go/src/runtime/asm_amd64.s:1373 Advice:VirtualBox and Hyper-V are having a conflict. Use '--driver=hyperv' or disable Hyper-V using: 'bcdedit /set hypervisorlaunchtype off' URL: Issues:[4051 4783] ShowIssueLink:false}
* [VBOX_HYPERV_64_BOOT] error provisioning host Failed to start host: creating host: create: precreate: This computer is running Hyper-V. VirtualBox won't boot a 64bits VM when Hyper-V is activated. Either use Hyper-V as a driver, or disable the Hyper-V hypervisor. (To skip this check, use --virtualbox-no-vtx-check)
* Âª∫ËÆÆÔºöVirtualBox and Hyper-V are having a conflict. Use '--driver=hyperv' or disable Hyper-V using: 'bcdedit /set hypervisorlaunchtype off'
* Áõ∏ÂÖ≥ÈóÆÈ¢òÔºö
  - https://github.com/kubernetes/minikube/issues/4051
  - https://github.com/kubernetes/minikube/issues/4783

```

Êä•Èîô‰ø°ÊÅØËøòÊòØÂæàÊ∏ÖÊ•öÔºåËøêË°åÊó∂ÂÜ≤Á™ÅÔºö
- ‰ΩøÁî®ÁÆ°ÁêÜÂëòÊùÉÈôêÊâßË°å`bcdedit /set hypervisorlaunchtype off`ÔºåÊàêÂäüÂêéÔºåËøòÊòØÊèêÁ§∫Áõ∏ÂêåÁöÑÈóÆÈ¢ò„ÄÇ
- ‰ΩøÁî®`--virtualbox-no-vtx-check` ÊèêÁ§∫Ëøô‰∏™`Error: unknown flag: --virtualbox-no-vtx-check` ÂèØ‰ª•See `minikube start --help' for usage.`

ÊûúÁÑ∂ÔºåÁé∞Âú®ÁöÑÂèÇÊï∞ÊòØ`--no-vtx-check=true`„ÄÇÊâÄ‰ª•ÂÆåÊï¥ÁöÑÂèÇÊï∞Â∫îËØ•ÊòØ`minikube start --driver=virtualbox --no-vtx-check=true`

‰∏çÂπ∏ÁöÑÊó∂ÔºåËøòÊòØÈÅáÂà∞ÈóÆÈ¢ò‰∫Ü

```
PS D:\> minikube start --driver=virtualbox --no-vtx-check=true
* Microsoft Windows 10 Education 10.0.18363 Build 18363 ‰∏äÁöÑ minikube v1.12.3
* Ê†πÊçÆÁé∞ÊúâÁöÑÈÖçÁΩÆÊñá‰ª∂‰ΩøÁî® virtualbox È©±Âä®Á®ãÂ∫è
* Starting control plane node minikube in cluster minikube
* Creating virtualbox VM (CPUs=4, Memory=6000MB, Disk=20000MB) ...
* Ê≠£Âú® Docker 19.03.12 ‰∏≠ÂáÜÂ§á Kubernetes v1.18.3‚Ä¶
* Unable to load cached images: loading cached images: transferring cached image: sudo test -d /var/lib/minikube/images && sudo scp -t /var/lib/minikube/images && sudo touch -d "2020-08-21 17:31:20.5418176 +0800" /var/lib/minikube/images/etcd_3.4.3-0: wait: remote command exited without exit status or exit signal
output:
...
stdout:

stderr:
fatal error: index out of range
runtime: panic before malloc heap initialized

```

ÊâßË°å`bcdedit /set hypervisorlaunchtype off`‰πãÂêéÂá∫Áé∞dockerÊó†Ê≥ïÂêØÂä®ÊÉÖÂÜµÔºüÁÆ°ÁêÜÂëòÊùÉÈôêÊâßË°å`bcdedit /Set {current} hypervisorlaunchtype auto`ÊÅ¢Â§çÂàùÂßãÂÄºÔºåÊâßË°å`bcdedit`ÂèØÁúãÂà∞ÂÖ®ÈÉ®ÈÖçÁΩÆ‰ø°ÊÅØ„ÄÇ

Ëá™Âä®ÊèêÁ§∫ÈìæÊé•‰∏∫[VIRTUALIZATION MUST BE ENABLED](https://docs.docker.com/docker-for-windows/troubleshoot/#virtualization-must-be-enabled)Ôºå‰ΩÜÊ£ÄÊü•ÊòØÁ¨¶ÂêàË¶ÅÊ±ÇÁöÑ„ÄÇÈáçÂêØÂêéÂÜçÁúãÂêß„ÄÇÊé•ÁùÄÂÖàÂæÄ‰∏ãÂ≠¶ËØæÁ®ã„ÄÇ


