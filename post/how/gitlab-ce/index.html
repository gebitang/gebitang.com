<!doctype html><html xmlns:wb=http://open.weibo.com/wb lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests"><meta name=description content><meta name=generator content="Hugo 0.134.0"><title>Gitlab-CE &#183; 戈壁堂</title>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=http://gebitang.com/css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=http://gebitang.com/css/side-menu.css><!--<![endif]--><link rel=stylesheet href=http://gebitang.com/css/blackburn.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.9.0/css/all.css><link href="https://fonts.googleapis.com/css?family=Raleway" rel=stylesheet type=text/css><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js></script><script>hljs.initHighlightingOnLoad()</script><link rel="shortcut icon" href=http://gebitang.com/img/favicon.ico type=image/x-icon><link rel=stylesheet href=http://gebitang.com/css/my.css><script src=http://gebitang.com/js/my.js></script></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><a class="pure-menu-heading brand" href=http://gebitang.com/>Gebitang</a><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/post/><i class='fa fa-list fa-fw'></i>Posts</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/about/><i class='fa fa-user fa-fw'></i>About</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/contact/><i class='fa fa-phone fa-fw'></i>Contact</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/topics/><i class='fa fa-folder fa-fw'></i>Topics</a></li></ul></div><div class="pure-menu social"><ul class=pure-menu-list></ul></div><div><div class=small-print><small><a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt=知识共享许可协议 style=border-width:0 src=https://i.creativecommons.org/l/by/4.0/80x15.png></a><br>本<span xmlns:dct=http://purl.org/dc/terms/ href=http://purl.org/dc/dcmitype/Text rel=dct:type>作品</span>由<a xmlns:cc=http://creativecommons.org/ns# href=http://gebitang.com property="cc:attributionName" rel=cc:attributionURL>&nbsp;Gebitang&nbsp;&nbsp;</a>采用<a rel=license href=http://creativecommons.org/licenses/by/4.0/>知识共享署名 4.0 国际许可协议</a>进行许可&nbsp;&copy; 2018</small></div><div class=small-print><small></small></div><div class=small-print><small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small></div><div style=display:none><div class=small-print><small><wb:follow-button uid=2446212465 type=red_1 width=67 height=24></wb:follow-button></small></div></div></div></div><div id=main><div class=header><h1>Gitlab-CE</h1><h2></h2></div><div class=content><div class=post-meta><div><i class="fa fa-calendar fa-fw"></i>
<time>2020-11-09</time></div><div><i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=http://gebitang.com/topics/jiansh>jiansh</a>&nbsp;/
<a class=post-taxonomy-topic href=http://gebitang.com/topics/gitlab>gitlab</a></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=http://gebitang.com/tags/gitlab>gitlab</a></div></div><nav id=TableOfContents><ul><li><a href=#安装gitlab-ce>安装Gitlab CE</a></li><li><a href=#安装gitlab-runner>安装gitlab runner</a><ul><li><a href=#注册runner>注册runner</a></li></ul></li></ul></nav><p><a href=https://docs.gitlab.com/ce/ci/quick_start/README.html>官方快速入门文档</a><br><code>.gitlab-ci.yml</code>文件<a href=https://gitlab.com/gitlab-org/gitlab-foss/blob/master/.gitlab-ci.yml>官方示例</a><br><a href=https://docs.gitlab.com/ce/ci/yaml/README.html>.gitlab-ci.yml完整说明</a></p><p>语法验证，可以在项目对应的目录<code>/gitlab-org/project-123/-/ci/lint</code> 进行验证
查看搭建的gitlab系统版本<code>/api/v4/version</code>，返回类似<code>{"version":"11.11.3","revision":"e3eeb779d72"}</code>的内容。</p><p>配置完成后，需要对应的<code>Gitlab Runner</code>配合执行<code>.gitlab-ci.yml</code>文件中对应的任务。<a href=https://docs.gitlab.com/runner/>runner 官方文档</a>。</p><h2 id=安装gitlab-ce>安装Gitlab CE</h2><p><a href="https://about.gitlab.com/install/?version=ce#ubuntu">安装一个CE版本</a>，自己实践一下——</p><pre tabindex=0><code>#依赖
sudo apt-get install -y curl openssh-server ca-certificates
#邮件
sudo apt-get install -y postfix
#添加源
curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash
#安装
sudo EXTERNAL_URL=&#34;http://your.domain:port&#34; apt-get install gitlab-ce


Reading state information... Done
The following packages were automatically installed and are no longer required:
  libopts25 sntp
Use &#39;sudo apt autoremove&#39; to remove them.
The following NEW packages will be installed:
  gitlab-ce
0 upgraded, 1 newly installed, 0 to remove and 50 not upgraded.
Need to get 742 MB of archives.
After this operation, 1,927 MB of additional disk space will be used.
</code></pre><p>按照固定带宽在下载，看起来要慢慢等了。</p><p><a href=https://stackoverflow.com/questions/33254100/502-whoops-gitlab-is-taking-too-much-time-to-respond>502 Whoops, GitLab is taking too much time to respond</a></p><p>看起来我的小破机器跑不起来gitlab的。GitLab requires at least 2GB RAM + 2GB swap memory</p><hr><p>手动安装，下载deb包之后，执行<code>sudo EXTERNAL_URL="http://your.domain:port" dpkg -i gitlab-ce_12.6.2-ce.0_amd64.deb</code>即可。</p><p><a href=https://docs.gitlab.com/omnibus/manual_install.html>manual install</a></p><hr><pre tabindex=0><code>#Turn off all swap processes
sudo swapoff -a

#Resize the swap
sudo dd if=/dev/zero of=/swapfile bs=1G count=8
#if = input file
#of = output file
#bs = block size
#count = multiplier of blocks

#Make the file usable as swap
sudo mkswap /swapfile

#Activate the swap file
sudo swapon /swapfile
#Check the amount of swap available
grep SwapTotal /proc/meminfo
</code></pre><p>手动增大SWAP区域之后，至少启动起来了
<img src=https://upload-images.jianshu.io/upload_images/3296949-edb2e36c11231fd9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240 alt></p><p><a href=https://docs.gitlab.com/omnibus/settings/configuration.html#configuring-the-external-url-for-gitlab>修改主页</a></p><p><a href=https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md>安装完成后的配置</a></p><pre tabindex=0><code># Start all GitLab components
sudo gitlab-ctl start

# Stop all GitLab components
sudo gitlab-ctl stop

# Restart all GitLab components
sudo gitlab-ctl restart

# check log 
sudo gitlab-ctl tail
</code></pre><h2 id=安装gitlab-runner>安装gitlab runner</h2><p><a href=https://docs.gitlab.com/runner/install/>官方安装文档</a>，在已经启动的gitlab实例目录<code>/admin/runners</code>下可以看到安装步骤，需要管理员权限</p><p>Set up a shared Runner manually</p><ol><li><a href=https://docs.gitlab.com/runner/install/>Install GitLab Runner</a></li><li>Specify the following URL during the Runner setup: <code>http://xxx.com:port/</code> </li><li>Use the following registration token during setup: <code>token-value</code> </li><li>Start the Runner!</li></ol><p><a href=https://docs.gitlab.com/runner/>官方Runner文档</a>——</p><blockquote><p>GitLab Runner should be the same version as GitLab. Older runners may still work with newer GitLab versions, and vice versa. However, features may be not available or work properly if a version difference exists.</p></blockquote><p>Go语言编写，二进制发布，多平台支持。</p><p><a href=https://docs.gitlab.com/runner/install/bleeding-edge.html#download-any-other-tagged-release>历史版本</a>下载页面，根据 <a href=https://gitlab.com/gitlab-org/gitlab-runner>官方仓库</a>的<a href=https://gitlab.com/gitlab-org/gitlab-runner/-/tags>tag列表</a>的不同分支，选择对应的版本——</p><p>例如，v12.6版本，分支对应为<code>v12.6.0</code>，则二进制版本下载地址为<code>https://s3.amazonaws.com/gitlab-runner-downloads/**v12.6.0**/binaries/gitlab-runner-linux-386</code></p><ol><li>添加可执行权限：<code>sudo chmod +x gitlab-runner</code></li><li>创建执行用户：<code>sudo useradd --comment 'GitLab Runner' --create-home gitlab-runner --shell /bin/bash</code></li><li>安装为服务：</li></ol><pre tabindex=0><code>sudo gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner
sudo gitlab-runner start
</code></pre><ol start=4><li>注册runner，即将runner与gitlab绑定。<a href=https://docs.gitlab.com/runner/register/index.html>Register a runner</a></li></ol><p>建议是Gitlab和Gitlab Runner分离，但不考虑安全、性能的情况下，同时在一台机器上跑没有问题。参考 <a href=https://softwareengineering.stackexchange.com/questions/237238/ci-runner-on-same-server-of-gitlab>CI runner on same server of GitLab?</a>，或者 <a href=https://stackoverflow.com/questions/26466692/setting-up-gitlab-ci-on-server-with-gitlab-already-installed>Setting up GitLab CI on server with GitLab already installed</a></p><h3 id=注册runner>注册runner</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#拉取gitlab-runner镜像  </span>
</span></span><span style=display:flex><span>docker pull hub.xxx-cloud.com/library/gitlab-runner 
</span></span><span style=display:flex><span><span style=color:#75715e># 创建后台运行的容器   </span>
</span></span><span style=display:flex><span>docker run -it -d -v /var/run/docker.sock:/var/run/docker.sock image_id_hash
</span></span><span style=display:flex><span><span style=color:#75715e># 进入容器。</span>
</span></span><span style=display:flex><span>docker exec -it container_id_hash bash 
</span></span><span style=display:flex><span><span style=color:#75715e># 注册runner到gitlab-ce里，使用交互式注册 </span>
</span></span><span style=display:flex><span>gitlab-runner register 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>######交互过程</span>
</span></span><span style=display:flex><span>gitlab-runner register
</span></span><span style=display:flex><span>Runtime platform                                    arch<span style=color:#f92672>=</span>amd64 os<span style=color:#f92672>=</span>linux pid<span style=color:#f92672>=</span><span style=color:#ae81ff>45</span> revision<span style=color:#f92672>=</span>4745a6f3 version<span style=color:#f92672>=</span>11.8.0
</span></span><span style=display:flex><span>Running in system-mode.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Please enter the gitlab-ci coordinator URL <span style=color:#f92672>(</span>e.g. https://gitlab.com/<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>http://git.xxx-corp.com/
</span></span><span style=display:flex><span>Please enter the gitlab-ci token <span style=color:#66d9ef>for</span> this runner:
</span></span><span style=display:flex><span>91WAmfZyLYYRkvD8vR7B
</span></span><span style=display:flex><span>Please enter the gitlab-ci description <span style=color:#66d9ef>for</span> this runner:
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>02f73eb2bdc7<span style=color:#f92672>]</span>: local-runner-on-windows-pc-for-test
</span></span><span style=display:flex><span>Please enter the gitlab-ci tags <span style=color:#66d9ef>for</span> this runner <span style=color:#f92672>(</span>comma separated<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>med-geb,med-test
</span></span><span style=display:flex><span>Registering runner... succeeded                     runner<span style=color:#f92672>=</span>91WAmfZy
</span></span><span style=display:flex><span>Please enter the executor: docker+machine, kubernetes, docker, parallels, shell, ssh, virtualbox, docker-ssh, docker-ssh+machine:
</span></span><span style=display:flex><span>docker
</span></span><span style=display:flex><span>Please enter the default Docker image <span style=color:#f92672>(</span>e.g. ruby:2.1<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>hub.xxx-cloud.com/medusa/med-test:latest
</span></span><span style=display:flex><span>Runner registered successfully. Feel free to start it, but <span style=color:#66d9ef>if</span> it<span style=color:#960050;background-color:#1e0010>&#39;</span>s running already the config should be automatically reloaded!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#######交互过程结束</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看  /etc/gitlab-runner/config.toml 文件内容，可以看到详细的配置信息</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#启动runner   </span>
</span></span><span style=display:flex><span>gitlab-runner start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看帮助</span>
</span></span><span style=display:flex><span>gitlab-runner --help
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看注册帮助</span>
</span></span><span style=display:flex><span>gitlab-runner register --help
</span></span></code></pre></div><div class="prev-next-post pure-g"><div class=pure-u-1-24 style=text-align:left><a href=http://gebitang.com/post/2020/sep-and-oct-run/><i class="fa fa-chevron-left"></i></a></div><div class=pure-u-10-24><nav class=prev><a href=http://gebitang.com/post/2020/sep-and-oct-run/>Septemper and Octomber Run</a></nav></div><div class=pure-u-2-24>&nbsp;</div><div class=pure-u-10-24><nav class=next><a href=http://gebitang.com/post/what/chang-e-five/>嫦娥五号</a></nav></div><div class=pure-u-1-24 style=text-align:right><a href=http://gebitang.com/post/what/chang-e-five/><i class="fa fa-chevron-right"></i></a></div></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="gebitang",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><script src=http://gebitang.com/js/ui.js></script><script src=http://gebitang.com/js/menus.js></script><script>window.location.hostname!="localhost"&&(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-34303694-1","auto"),ga("send","pageview"))</script><button onclick=topFunction() id=myBtn title="Go to top">Top</button></body></html>