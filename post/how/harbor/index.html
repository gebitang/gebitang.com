<!doctype html><html xmlns:wb=http://open.weibo.com/wb lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="harbor"><meta name=generator content="Hugo 0.98.0"><title>harbor basic &#183; 戈壁堂</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=http://gebitang.com/css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=http://gebitang.com/css/side-menu.css><!--<![endif]--><link rel=stylesheet href=http://gebitang.com/css/blackburn.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.9.0/css/all.css><link href="https://fonts.googleapis.com/css?family=Raleway" rel=stylesheet type=text/css><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js></script>
<script>hljs.initHighlightingOnLoad()</script><link rel="shortcut icon" href=http://gebitang.com/img/favicon.ico type=image/x-icon><link rel=stylesheet href=http://gebitang.com/css/my.css><script src=http://gebitang.com/js/my.js></script></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><a class="pure-menu-heading brand" href=http://gebitang.com/>Gebitang</a><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/><i class="fa fa-home fa-fw"></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/post/><i class="fa fa-list fa-fw"></i>Posts</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/about/><i class="fa fa-user fa-fw"></i>About</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/contact/><i class="fa fa-phone fa-fw"></i>Contact</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/tags/><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/topics/><i class="fa fa-folder fa-fw"></i>Topics</a></li></ul></div><div class="pure-menu social"><ul class=pure-menu-list></ul></div><div><div class=small-print><small><a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt=知识共享许可协议 style=border-width:0 src=https://i.creativecommons.org/l/by/4.0/80x15.png></a><br>本<span xmlns:dct=http://purl.org/dc/terms/ href=http://purl.org/dc/dcmitype/Text rel=dct:type>作品</span>由<a xmlns:cc=http://creativecommons.org/ns# href=http://gebitang.com property="cc:attributionName" rel=cc:attributionurl>&nbsp;Gebitang&nbsp;&nbsp;</a>采用<a rel=license href=http://creativecommons.org/licenses/by/4.0/>知识共享署名 4.0 国际许可协议</a>进行许可&nbsp;&copy; 2018</small></div><div class=small-print><small></small></div><div class=small-print><small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small></div><div style=display:none><div class=small-print><small><wb:follow-button uid=2446212465 type=red_1 width=67 height=24></wb:follow-button></small></div></div></div></div><div id=main><div class=header><h1>harbor basic</h1><h2>harbor</h2></div><div class=content><div class=post-meta><div><i class="fa fa-calendar fa-fw"></i>
<time>2022-03-17</time></div><div><i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=http://gebitang.com/topics/harbor>harbor</a></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=http://gebitang.com/tags/harbor>harbor</a></div></div><nav id=TableOfContents><ul><li><a href=#云原生制品那些事artifact>云原生制品那些事(artifact)</a></li><li><a href=#harbor系统>harbor系统</a><ul><li><a href=#前世今生>前世今生</a></li><li><a href=#架构10>架构1.0</a></li><li><a href=#架构20>架构2.0</a></li><li><a href=#升级>升级</a></li><li><a href=#其他>其他</a></li><li><a href=#参考资料>参考资料</a></li></ul></li></ul></nav><h2 id=云原生制品那些事artifact>云原生制品那些事(artifact)</h2><p><a href=https://book.douban.com/subject/35220390/>Harbor权威指南：容器镜像、Helm Chart等云原生制品的管理与实践</a>，2020年11月出版</p><ul><li><p>第一篇：容器镜像的结构(=1.4.1~1.4.4)</p></li><li><p>第二篇：OCI 镜像规范(=1.4.5)</p></li><li><p>第三篇：OCI 制品(=1.5.2~1.5.3)</p></li><li><p>第四篇：Registry 的作用原理(=1.6.1)</p></li><li><p><a href=https://mp.weixin.qq.com/s/ScEw2-y7Gea01pEekYXkgw>云原生制品那些事(1)：容器镜像</a></p></li><li><p><a href=https://mp.weixin.qq.com/s/TVIz8p8nOj4ffYaECW7gVg>云原生制品那些事(2)：OCI 镜像规范</a></p></li><li><p><a href=https://mp.weixin.qq.com/s/okFbunMWFLWfjwCjFbceZw>云原生制品那些事(3)：OCI 制品Artifact</a></p></li><li><p><a href=https://mp.weixin.qq.com/s/r3xNEw6tT34TB_1Qr_z9lQ>云原生制品那些事(4)：Registry作用原理</a></p></li></ul><p>OCI 定义的镜像包括4个部分——</p><ul><li>镜像索引（Image Index）：可选内容，指向镜像不同平台的版本，如 i386 和 arm64v8、Linux 和Windows</li><li>清单（Manifest）：说明镜像包含的配置和内容的文件</li><li>配置（Configuration）：描述容器的根文件系统和容器运行时使用的执行参数，还有一些镜像的元数据。</li><li>层文件（Layers）： 镜像的根文件系统由多个层文件叠加而成。每个层文件在分发时都必须被打包成一个tar文件，可选择压缩或者非压缩的方式，压缩工具可以是gzip或者zstd。</li></ul><pre tabindex=0><code># docker manifest inspect hello-world
{
	&#34;schemaVersion&#34;: 2,
	&#34;mediaType&#34;: &#34;application/vnd.docker.distribution.manifest.v2+json&#34;,
	&#34;config&#34;: {
			&#34;mediaType&#34;: &#34;application/vnd.docker.container.image.v1+json&#34;,
			&#34;size&#34;: 1520,
			&#34;digest&#34;: &#34;sha256:1815c82652c03bfd8644afda26fb184f2ed891d921b20a0703b46768f9755c57&#34;
	},
	&#34;layers&#34;: [
			{
				&#34;mediaType&#34;: &#34;application/vnd.docker.image.rootfs.diff.tar.gzip&#34;,
				&#34;size&#34;: 972,
				&#34;digest&#34;: &#34;sha256:b04784fba78d739b526e27edc02a5a8cd07b1052e9283f5fc155828f4b614c28&#34;
			}
	]
}

# Image Index example
{

  &#34;schemaVersion&#34;: 2,
  &#34;manifests&#34;: [
    {
      &#34;mediaType&#34;: &#34;application/vnd.oci.image.manifest.v1+json&#34;,
      &#34;size&#34;: 8342,
      &#34;digest&#34;: &#34;sha256:d81ae89b30523f5152fe646c1f9d178e5d10f28d00b70294fca965b7b96aa3db&#34;,
      &#34;platform&#34;: {
        &#34;architecture&#34;: &#34;arm64v8&#34;,
        &#34;os&#34;: &#34;linux&#34;
      }
    },
    {
      &#34;mediaType&#34;: &#34;application/vnd.oci.image.manifest.v1+json&#34;,
      &#34;size&#34;: 6439,
      &#34;digest&#34;: &#34;sha256:2ef4e3904905353a0c4544913bc0caa48d95b746ef1f2fe9b7c85b3badff987e&#34;,
      &#34;platform&#34;: {
        &#34;architecture&#34;: &#34;amd64&#34;,
        &#34;os&#34;: &#34;linux&#34;
      }
    }
  ],
  &#34;annotations&#34;: {
    &#34;io.harbor.key1&#34;: &#34;value1&#34;,
    &#34;io.harbor.key2&#34;: &#34;value2&#34;
  }
}
# annotations 键值对形式的附加信息（可选项）。
</code></pre><h2 id=harbor系统>harbor系统</h2><h3 id=前世今生>前世今生</h3><p>Harbor Registry（又称 Harbor 云原生制品仓库或 Harbor 镜像仓库）由 VMware 公司中国研发中心云原生实验室原创，并于 2016 年 3 月开源。确切说是中心的<a href=https://mp.weixin.qq.com/s/26HiJb300yHFAbrLxBo6EQ>ATC团队(Advanced Technology Center)</a>发起，由张海宁带队发起。满足核心功能MVP：镜像pull && push。然后添加了四个核心功能——</p><ul><li>1）RBAC ，支持 LDAP/AD 认证</li><li>2）日志审计 （操作可追溯性）</li><li>3）镜像复制（多数据中心或云环境之间的镜像自动同步）</li><li>4）图形化管理界面（几乎是企业应用必备）</li></ul><p>看起来核心功能完全可以满足我们目前的需求，不需要升级到2.0版本哈。Docker依赖的基础技术早就存在，Docker的成功来自Docker Image的成功——成为事实标准之后，发展出后来的OPI。而Docker Engine大家都可以进行替代。</p><h3 id=架构10>架构1.0</h3><ul><li>2017年4月发布1.1版本</li><li>2019年5月Harbor 1.8发布(巴塞罗那举行的KubeCon欧洲大会上的主题演讲上)： OIDC SSO 认证，异构镜像仓库复制，CI/CD 自动化集成和健康监控</li><li>2019年10月Harbor 1.9发布：tag 保留和配额、可与 CI/CD 工具集成的 Webhook 通知、数据复制、Syslog 集成以及 CVE 例外策略等安全功能</li></ul><p><img src=https://ivanzz1001.github.io/records/assets/img/docker/docker_harbor_arch.png alt></p><p>Harbor在架构上主要由五个组件构成：</p><ul><li><p><strong>Proxy：</strong> Harbor的registry, UI, token等服务，通过一个前置的反向代理统一接收浏览器、Docker客户端的请求，并将请求转发给后端不同的服务。</p></li><li><p><strong>Registry：</strong> 负责储存Docker镜像，并处理dockerpush/pull 命令。由于我们要对用户进行访问控制，即不同用户对Docker image有不同的读写权限，Registry会指向一个token服务，强制用户的每次docker pull/push请求都要携带一个合法的token,Registry会通过公钥对token 进行解密验证。——使用S3代替本地存储的镜像内容</p></li><li><p><strong>Core services：</strong> 这是Harbor的核心功能，主要提供以下服务：</p><ul><li>UI：提供图形化界面，帮助用户管理registry上的镜像（image）, 并对用户进行授权。</li><li>webhook：为了及时获取registry 上image状态变化的情况， 在Registry上配置webhook，把状态变化传递给UI模块。</li><li>token服务：负责根据用户权限给每个docker push/pull命令签发token.Docker 客户端向Regiøstry服务发起的请求,如果不包含token，会被重定向到这里，获得token后再重新向Registry进行请求。</li></ul></li><li><p><strong>Database：</strong> 为coreservices提供数据库服务，负责储存用户权限、审计日志、Docker image分组信息等数据。</p></li><li><p><strong>Job services:</strong> 主要用于镜像复制，本地镜像可以被同步到远程Harbor实例上。</p></li><li><p><strong>Log collector：</strong> 为了帮助监控Harbor运行，负责收集其他组件的log，供日后进行分析。</p></li></ul><h3 id=架构20>架构2.0</h3><ul><li>2020年5月发布2.0版本，Harbor 2.0 成为符合 OCI（Open Container Initiatives）规范的开源镜像仓库，能够存储多种云原生工件（Artifacts），例如，容器镜像、Helm Chart、OPA、Singularity 等等。</li></ul><p><img src=https://static001.geekbang.org/infoq/2c/2c739f94956f8c792607ba0438e31f74.png alt></p><ul><li><p><strong>代理层：</strong> 代理层实质上是一个 Nginx 反向代理，负责接收不同类型的客户端请求，包括浏览器、用户脚本、Docker 等，并根据请求类型和 URI 转发给不同的后端服务进行处理。</p></li><li><p><strong>功能层：</strong></p><ul><li>Portal：是一个基于 Argular 的前端应用，提供 Harbor 用户访问的界面。</li><li>Core：是 Harbor 中的核心组件，封装了 Harbor 绝大部分的业务逻辑。</li><li>JobService：异步任务组件，负责 Harbor 中很多比较耗时的功能，比如 Artifact 复制、扫描、垃圾回收等。</li><li>Docker Distribution：Harbor 通过 Distribution 实现 Artifact 的读写和存取等功能。</li><li>RegistryCtl：Docker Distribution 的控制组件。</li><li>Notary（可选）：基于 TUF 提供镜像签名管理的功能。</li><li>扫描工具（可选）：镜像的漏洞检测工具。</li><li>ChartMuseum（可选）：提供 API 管理非 OCI 规范的 Helm Chart，随着兼容 OCI(Open Container Initiative) 规范的 Helm Chart 在社区上被更广泛地接受，Helm Chart 能以 Artifact 的形式在 Harbor 中存储和管理，不再依赖 ChartMuseum，因此 Harbor 可能会在后续版本中移除对 ChartMuseum 的支持。——最新版本应该已经去除ChartMuseum，都已OCI方式进行管理</li></ul></li><li><p><strong>数据层：</strong></p><ul><li>Redis：主要作为缓存服务存储一些生命周期较短的数据，同时对于 JobService 还提供了类似队列的功能。</li><li>PostgreSQL：存储 Harbor 的应用数据，比如项目信息、用户与项目的关系、管理策略、配置信息、Artifact 的元数据等等。</li><li>Artifact 存储：存储 Artifact 本身的内容，也就是每次推送镜像、Helm Chart 或其他 Artifact 时，数据最终存储的地方。默认情况下，Harbor 会把 Artifact 写入本地文件系统中。用户也可以修改配置，将 Artifact 存储在外部存储中，例如亚马逊的对象存储 S3、谷歌云存储 GCS、阿里云的对象存储 OSS 等等。</li></ul></li></ul><p>更新点：</p><ol><li>符合 OCI（Open Container Initiatives）规范的开源镜像仓库</li><li>Aqua Trivy 作为默认漏洞扫描器</li><li>机器人帐户功能（robot account）</li></ol><p>2020年9月发布2.1版本更新：</p><ul><li>镜像的代理和缓存</li><li>非阻塞的镜像垃圾回收</li><li>P2P镜像分发的预热</li><li>机器学习模型的管理</li><li>Sysdig镜像扫描器</li></ul><p>2021年3月发布了 v2.2 版本</p><ul><li>系统级（跨项目）机器人帐号</li><li>Prometheus 的支持</li><li>镜像的代理和缓存支持更多的公有云Registry，包括 AWS 的 ECR，谷歌云的GCR，Azure的 ACR 以及 Quay，避免 Docker Hub 的流量限制</li><li>OIDC 认证支持管理组 （与 LDAP 类似）</li><li>Aqua CSP 企业级扫描器集成</li><li>Dell EMC ECS S3 存储支持</li></ul><div class=pure-g><div class=pure-u-1-1><div style="padding:0 .2em"><a href=https://github.com/goharbor/harbor/wiki/Architecture-Overview-of-Harbor target=_blank><img class=pure-img-responsive src=https://raw.githubusercontent.com/goharbor/harbor/release-2.0.0/docs/img/architecture/architecture.png alt title="harbor architecture"></a></div></div></div><h3 id=升级>升级</h3><p><a href=https://mp.weixin.qq.com/s/dVCxvJRmOs47y0QaxkcGzQ>生产系统中升级 Harbor 的完整流程</a>。如果要升级到2.x版本，需要先从1.x升级到</p><blockquote><p>Harbor 2.0 中只支持以 1.9.x 或 1.10.x 两个版本为起点的升级迁移，所以需要先升级到这两个版本</p></blockquote><p>目前环境使用的至少harbor的核心功能，push&&pull。其他类似镜像复制、漏洞扫描、镜像签名、角色控制、垃圾清理等功能都没被用到。暂时还没啥直接升级的必要。需要的话，直接迁移使用2.x版本是更好的选择。</p><h3 id=其他>其他</h3><ul><li><p>关于<a href=https://opencontainers.org/>OCI</a>： 成立于2015年，Linux 基金会旗下的合作项目，以开放治理的方式制定操作系统虚拟化（特别是 Linux 容器）的开放工业标准。制定：容器运行时（runtime）规范、容器镜像(image)规范、以及处于讨论中的镜像分发（distribution）规范</p></li><li><p><a href=https://www.openpolicyagent.org/>OPA</a>：aka OPENPOLICYAGENT, Policy-based control for cloud native environments。The Open Policy Agent (OPA, pronounced “oh-pa”) is an open source, general-purpose policy engine that unifies policy enforcement across the stack.</p></li><li><p><a href=http://apptainer.org/>Singularity</a>: Apptainer, the container system for high-performance computing (HPC) formerly known as Singularity, has joined the Linux Foundation。变化真快哈~
还有一个<a href=https://github.com/sylabs/singularity>sylabs</a>公司，专门做Singularity相关服务，类似red hat vs. linux??</p></li></ul><h3 id=参考资料>参考资料</h3><ul><li><a href=https://mp.weixin.qq.com/s/XPDaI9XXnTH9kYv4dCTLwA>Harbor创始人Henry</a></li><li><a href=https://mp.weixin.qq.com/s/26HiJb300yHFAbrLxBo6EQ>巨轮起航，心怀诗和远方的港口&ndash;为什么做Harbor开源企业级Registry？</a></li><li><a href=https://mp.weixin.qq.com/s/aGRMZ5W_eUEJ9UF2XhfASw>Harbor：开源企业级容器Registry架构简介</a></li><li><a href=https://mp.weixin.qq.com/s/8KEHnd4LER-M9VhVQ478UA>Harbor开源镜像仓库的设计理念</a></li><li><a href=https://mp.weixin.qq.com/s/BEpfR0L2n1f5SdlRqgEWTA>Harbor 1.8开拓镜像管理崭新应用场景</a></li><li><a href=https://mp.weixin.qq.com/s/qS_ehznkkNDBlt_tqOQrGA>Harbor 1.9 新增多项企业级功能</a></li><li><a href=https://mp.weixin.qq.com/s/fJMbr3TQOctVdg8Y9PyALA>Harbor 2.0的飞跃: OCI 兼容的工件仓库</a></li><li><a href=https://ivanzz1001.github.io/records/post/docker/2018/04/20/docker-harbor-architecture>Harbor整体架构</a></li><li><a href=https://xie.infoq.cn/article/c54645b4c5f6857b66beec488>Habor2.x 入门指南</a></li><li><a href=https://mp.weixin.qq.com/s/BYhSyVeVROYMwIAdO3SbmA>Harbor 2.1发布，工程师的发际线有救了</a></li><li><a href=https://thenewstack.io/apptainer-a-container-system-for-high-performance-computing/>Apptainer, a Container System for High-Performance Computing</a></li><li><a href=https://github.com/goharbor/harbor/wiki/Architecture-Overview-of-Harbor>Architecture Overview of Harbor</a></li></ul><div class="prev-next-post pure-g"><div class=pure-u-1-24 style=text-align:left><a href=http://gebitang.com/post/how/ceph/><i class="fa fa-chevron-left"></i></a></div><div class=pure-u-10-24><nav class=prev><a href=http://gebitang.com/post/how/ceph/>Ceph Basic</a></nav></div><div class=pure-u-2-24>&nbsp;</div><div class=pure-u-10-24><nav class=next><a href=http://gebitang.com/post/how/kubernetes/>k8s practice</a></nav></div><div class=pure-u-1-24 style=text-align:right><a href=http://gebitang.com/post/how/kubernetes/><i class="fa fa-chevron-right"></i></a></div></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="gebitang",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><script src=http://gebitang.com/js/ui.js></script>
<script src=http://gebitang.com/js/menus.js></script>
<script>window.location.hostname!="localhost"&&(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-34303694-1","auto"),ga("send","pageview"))</script><button onclick=topFunction() id=myBtn title="Go to top">Top</button></body></html>