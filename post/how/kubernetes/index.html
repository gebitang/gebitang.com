<!doctype html><html xmlns:wb=http://open.weibo.com/wb lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="the way to kubernetes">
<meta name=generator content="Hugo 0.91.2">
<title>k8s practice &#183; æˆˆå£å ‚</title>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!-->
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=http://gebitang.com/css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!-->
<link rel=stylesheet href=http://gebitang.com/css/side-menu.css><!--<![endif]-->
<link rel=stylesheet href=http://gebitang.com/css/blackburn.css>
<link rel=stylesheet href=https://use.fontawesome.com/releases/v5.9.0/css/all.css>
<link href="https://fonts.googleapis.com/css?family=Raleway" rel=stylesheet type=text/css>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css>
<script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js></script>
<script>hljs.initHighlightingOnLoad()</script>
<link rel="shortcut icon" href=http://gebitang.com/img/favicon.ico type=image/x-icon>
<link rel=stylesheet href=http://gebitang.com/css/my.css>
<script src=http://gebitang.com/js/my.js></script>
</head>
<body>
<div id=layout>
<a href=#menu id=menuLink class=menu-link>
<span></span>
</a>
<div id=menu>
<a class="pure-menu-heading brand" href=http://gebitang.com/>Gebitang</a>
<div class=pure-menu>
<ul class=pure-menu-list>
<li class=pure-menu-item>
<a class=pure-menu-link href=http://gebitang.com/><i class="fa fa-home fa-fw"></i>Home</a>
</li>
<li class=pure-menu-item>
<a class=pure-menu-link href=http://gebitang.com/post/><i class="fa fa-list fa-fw"></i>Posts</a>
</li>
<li class=pure-menu-item>
<a class=pure-menu-link href=http://gebitang.com/about/><i class="fa fa-user fa-fw"></i>About</a>
</li>
<li class=pure-menu-item>
<a class=pure-menu-link href=http://gebitang.com/contact/><i class="fa fa-phone fa-fw"></i>Contact</a>
</li>
<li class=pure-menu-item>
<a class=pure-menu-link href=http://gebitang.com/tags/><i class="fa fa-tags fa-fw"></i>Tags</a>
</li>
<li class=pure-menu-item>
<a class=pure-menu-link href=http://gebitang.com/topics/><i class="fa fa-folder fa-fw"></i>Topics</a>
</li>
</ul>
</div>
<div class="pure-menu social">
<ul class=pure-menu-list>
</ul>
</div>
<div>
<div class=small-print>
<small>
<a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt=çŸ¥è¯†å…±äº«è®¸å¯åè®® style=border-width:0 src=https://i.creativecommons.org/l/by/4.0/80x15.png></a><br>æœ¬<span xmlns:dct=http://purl.org/dc/terms/ href=http://purl.org/dc/dcmitype/Text rel=dct:type>ä½œå“</span>ç”±<a xmlns:cc=http://creativecommons.org/ns# href=http://gebitang.com property="cc:attributionName" rel=cc:attributionurl>&nbsp;Gebitang&nbsp;&nbsp;</a>é‡‡ç”¨<a rel=license href=http://creativecommons.org/licenses/by/4.0/>çŸ¥è¯†å…±äº«ç½²å 4.0 å›½é™…è®¸å¯åè®®</a>è¿›è¡Œè®¸å¯&nbsp;&copy; 2018
</small>
</div>
<div class=small-print>
<small></small>
</div>
<div class=small-print>
<small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small>
</div>
<div style=display:none>
<div class=small-print>
<small>
<wb:follow-button uid=2446212465 type=red_1 width=67 height=24></wb:follow-button>
</small>
</div>
</div>
</div>
</div>
<div id=main>
<div class=header>
<h1>k8s practice</h1>
<h2>the way to kubernetes</h2>
</div>
<div class=content>
<div class=post-meta>
<div>
<i class="fa fa-calendar fa-fw"></i>
<time>2020-08-23</time>
</div>
<div>
<i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=http://gebitang.com/topics/kubernetes>kubernetes</a>&nbsp;/
<a class=post-taxonomy-topic href=http://gebitang.com/topics/k8s>k8s</a>
</div>
<div>
<i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=http://gebitang.com/tags/kubernetes>kubernetes</a>&nbsp;/
<a class=post-taxonomy-tag href=http://gebitang.com/tags/k8s>k8s</a>
</div>
</div>
<nav id=TableOfContents>
<ul>
<li><a href=#tasks>Tasks</a>
<ul>
<li><a href=#æ›´æ–°daemonset>æ›´æ–°DaemonSet</a></li>
<li><a href=#ç®¡ç†å†…å­˜cpué…é¢>ç®¡ç†å†…å­˜ã€CPUã€é…é¢</a></li>
</ul>
</li>
<li><a href=#start-over>start over</a>
<ul>
<li><a href=#wsl2-æ—¶é—´åŒæ­¥>wsl2 æ—¶é—´åŒæ­¥</a></li>
<li><a href=#kubernetes-tutorial>Kubernetes Tutorial</a></li>
<li><a href=#k8sä¸­çš„crdå¼€å‘>K8Sä¸­çš„CRDå¼€å‘</a></li>
<li><a href=#setup-with-dashboard>setup with dashboard</a></li>
</ul>
</li>
<li><a href=#archive>archive</a>
<ul>
<li><a href=#æœ¯è¯­åˆ—è¡¨>æœ¯è¯­åˆ—è¡¨</a></li>
<li><a href=#wsl2--kubernetes>WSL2 + Kubernetes</a></li>
<li><a href=#errors-were-encountered-while-processing--ubuntu-advantage-tools>Errors were encountered while processing: ubuntu-advantage-tools</a></li>
<li><a href=#å‰æç¯å¢ƒ>å‰æç¯å¢ƒ</a></li>
</ul>
</li>
</ul>
</nav>
<h2 id=tasks>Tasks</h2>
<p>ç»ƒä¹ è®°å½•ï¼Œ<a href=https://kubernetes.io/docs/tasks/>å®˜æ–¹Tasks</a>ï¼Œ<a href=https://kubernetes.io/zh/docs/tasks/>ä¸­æ–‡ç‰ˆæœ¬å¯¹ç…§</a>è·Ÿç€ç»ƒä¹ ä¸€éä¹‹åï¼Œå„ä¸ªæ¦‚å¿µå°±æ¸…æ¥šäº†ã€‚</p>
<h3 id=æ›´æ–°daemonset>æ›´æ–°DaemonSet</h3>
<p><a href=https://kubernetes.io/zh/docs/tasks/manage-daemon/update-daemon-set/>å¯¹ DaemonSet æ‰§è¡Œæ»šåŠ¨æ›´æ–°</a>ï¼Œæœ¬åœ°æ§åˆ¶DOçš„é›†ç¾¤ï¼Œé»˜è®¤ä¼šè¶…æ—¶ï¼Œæ— æ³•applyå¯¹è±¡ï¼Œæç¤º</p>
<pre tabindex=0><code>E1123 19:37:27.679680     511 request.go:1027] Unexpected error when reading response body: net/http: request canceled (Client.Timeout or context cancellation while reading body)
error: unexpected error when reading response body. Please retry. Original error: net/http: request canceled (Client.Timeout or context cancellation while reading body)
# æˆ–è€… 
Unable to connect to the server: net/http: TLS handshake timeout
</code></pre><p>å¢åŠ è¶…æ—¶æ—¶é—´è®¾ç½®<code>k apply -f xxx.yaml --request-timeout="50"</code>ï¼Œè¿˜å¯ä»¥æŒ‡å®šlogçº§åˆ«<code>-v=6</code>ï¼Œå‚è€ƒ<a href=https://www.mtioutput.com/entry/kubectl-timeout-error>ã€Kubernetesã€‘Client.Timeout or context cancellation while reading bodyã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã®è§£æ¶ˆæ–¹æ³•</a></p>
<ul>
<li>è®¾ç½®DaemonSetå†…å®¹ï¼ŒæŸ¥çœ‹æ›´æ–°ç­–ç•¥<code>kubectl get ds/fluentd-elasticsearch -n kube-system -o go-template='{{.spec.updateStrategy.type}}{{"\n"}}'</code> æŸ¥çœ‹æ–¹å¼ä¹Ÿå¯ä»¥ä¸º <code>-o yaml</code></li>
<li>å¯¹ RollingUpdate DaemonSet çš„ <code>.spec.template</code> çš„ä»»ä½•æ›´æ–°éƒ½å°†è§¦å‘æ»šåŠ¨æ›´æ–°ã€‚ä¾‹å¦‚å¢åŠ äº†cpuå’Œå†…å­˜çš„é™åˆ¶</li>
</ul>
<p>ä»¥ä¸‹æ–¹å¼éƒ½å¯ä»¥æ›´æ–°â€”â€”</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># å£°æ˜å¼å‘½ä»¤</span>
kubectl apply -f https://k8s.io/examples/controllers/fluentd-daemonset-update.yaml
<span style=color:#75715e># æŒ‡ä»¤å¼å‘½ä»¤ Edit a resource from the default editor.</span>
kubectl edit ds/fluentd-elasticsearch -n kube-system <span style=color:#75715e>#æ‰“å¼€æ–‡ä»¶ç¼–è¾‘ï¼Œä¿æŒã€‚è¿œç¨‹ä¸å»ºè®®è¿™æ ·æ“ä½œ</span>
<span style=color:#75715e># åªæ›´æ–°å®¹å™¨é•œåƒ</span>
kubectl set image ds/fluentd-elasticsearch fluentd-elasticsearch<span style=color:#f92672>=</span>quay.io/fluentd_elasticsearch/fluentd:v2.6.0 -n kube-system
</code></pre></div><p>æ›´æ–°ç»“æœç±»ä¼¼â€”â€”</p>
<pre tabindex=0><code>myu@Gebitang:~$ k apply -f fluentd-daemonset-update.yaml
daemonset.apps/fluentd-elasticsearch configured
myu@Gebitang:~$ kubectl rollout status ds/fluentd-elasticsearch -n kube-system
Waiting for daemon set &quot;fluentd-elasticsearch&quot; rollout to finish: 1 out of 3 new pods have been updated...
Waiting for daemon set &quot;fluentd-elasticsearch&quot; rollout to finish: 1 out of 3 new pods have been updated...
Waiting for daemon set &quot;fluentd-elasticsearch&quot; rollout to finish: 2 out of 3 new pods have been updated...
Waiting for daemon set &quot;fluentd-elasticsearch&quot; rollout to finish: 2 out of 3 new pods have been updated...
Waiting for daemon set &quot;fluentd-elasticsearch&quot; rollout to finish: 2 out of 3 new pods have been updated...
Waiting for daemon set &quot;fluentd-elasticsearch&quot; rollout to finish: 2 of 3 updated pods are available...
daemon set &quot;fluentd-elasticsearch&quot; successfully rolled out
</code></pre><p>ä»åå­—ç©ºé—´ä¸­åˆ é™¤ DaemonSetï¼š<code>kubectl delete ds fluentd-elasticsearch -n kube-system</code></p>
<h3 id=ç®¡ç†å†…å­˜cpué…é¢>ç®¡ç†å†…å­˜ã€CPUã€é…é¢</h3>
<p><a href=https://kubernetes.io/zh/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/>ç®¡ç†å†…å­˜</a>ï¼Œæç¤º<code>looking up service account default-mem-example/default: serviceaccount "default" not found</code>ï¼Œæ„å‘³ç€æ²¡æœ‰æœåŠ¡è´¦å·(é»˜è®¤ç©ºé—´æœ‰é»˜è®¤çš„è´¦å·ï¼Œä½†æ–°åˆ›å»ºçš„namespaceä¸‹æ²¡æœ‰æœåŠ¡è´¦æˆ·)ï¼Œå¯ä»¥å…ˆæ‰§è¡Œä»»åŠ¡<a href=https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-service-account/>ä¸ºpodé…ç½®æœåŠ¡è´¦æˆ·</a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl create -f - <span style=color:#e6db74>&lt;&lt;EOF
</span><span style=color:#e6db74>apiVersion: v1
</span><span style=color:#e6db74>kind: ServiceAccount
</span><span style=color:#e6db74>metadata:
</span><span style=color:#e6db74>  name: default
</span><span style=color:#e6db74>  namespace: default-mem-example
</span><span style=color:#e6db74>EOF</span>
<span style=color:#75715e># ç„¶åå†åœ¨å¯¹åº”ç©ºé—´ä¸‹åˆ›å»ºpodå³å¯</span>
</code></pre></div><p>æ‰§è¡Œåˆ é™¤namespaceçš„å‘½ä»¤å<code>k delete namespace default-mem-example</code>ï¼Œä¸€ç›´æ²¡æœ‰è¿”å›ç»“æœï¼ŒCtrl+Cå¼ºåˆ¶ç»“æŸï¼ŒæŸ¥çœ‹çŠ¶æ€æ˜¾ç¤ºä¸º<code>Terminating</code>ï¼Œå‚è€ƒ<a href=https://stackoverflow.com/questions/52369247/namespace-stuck-as-terminating-how-i-removed-it>Namespace &ldquo;stuck&rdquo; as Terminating, How I removed it</a>ï¼Œå½“å‰ç©ºé—´ä¸‹è¿˜æœ‰å…¶ä»–èµ„æºï¼Ÿ<code>kubectl api-resources --verbs=list --namespaced -o name | xargs -n 1 kubectl get --show-kind --ignore-not-found -n default-mem-example</code>ï¼Œåˆ é™¤å¯¹åº”çš„èµ„æºåï¼ŒçŠ¶æ€ä¾ç„¶ä¸º<code>Terminating</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>geb@Gebitang:~$ k delete limitranges --namespace<span style=color:#f92672>=</span>default-mem-example
error: resource<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> were provided, but no name was specified
geb@Gebitang:~$ k delete limitrange/mem-limit-range --namespace<span style=color:#f92672>=</span>default-mem-example
limitrange <span style=color:#e6db74>&#34;mem-limit-range&#34;</span> deleted
geb@Gebitang:~$ k delete serviceaccount/default --namespace<span style=color:#f92672>=</span>default-mem-example
serviceaccount <span style=color:#e6db74>&#34;default&#34;</span> deleted

<span style=color:#75715e># æŸ¥çœ‹ç©ºé—´ä¿¡æ¯ k get namespace default-mem-example -o json</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;apiVersion&#34;</span>: <span style=color:#e6db74>&#34;v1&#34;</span>,
    <span style=color:#f92672>&#34;kind&#34;</span>: <span style=color:#e6db74>&#34;Namespace&#34;</span>,
    <span style=color:#f92672>&#34;metadata&#34;</span>: {
        <span style=color:#f92672>&#34;creationTimestamp&#34;</span>: <span style=color:#e6db74>&#34;2021-11-23T07:17:26Z&#34;</span>,
        <span style=color:#f92672>&#34;deletionTimestamp&#34;</span>: <span style=color:#e6db74>&#34;2021-11-23T07:55:36Z&#34;</span>,
        <span style=color:#f92672>&#34;labels&#34;</span>: {
            <span style=color:#f92672>&#34;kubernetes.io/metadata.name&#34;</span>: <span style=color:#e6db74>&#34;default-mem-example&#34;</span>
        },
        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;default-mem-example&#34;</span>,
        <span style=color:#f92672>&#34;resourceVersion&#34;</span>: <span style=color:#e6db74>&#34;2161742&#34;</span>,
        <span style=color:#f92672>&#34;uid&#34;</span>: <span style=color:#e6db74>&#34;7f0fd528-b681-45f7-887e-49820024333e&#34;</span>
    },
    <span style=color:#f92672>&#34;spec&#34;</span>: {
        <span style=color:#f92672>&#34;finalizers&#34;</span>: [
            <span style=color:#e6db74>&#34;kubernetes&#34;</span>
        ]
    },
    <span style=color:#f92672>&#34;status&#34;</span>: {
        <span style=color:#f92672>&#34;phase&#34;</span>: <span style=color:#e6db74>&#34;Terminating&#34;</span>
    }
}
</code></pre></div><p>è°ƒç”¨apiï¼Œå°†finalizerså­—æ®µç½®ç©ºå³å¯ï¼š</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># ä½¿ç”¨proxyï¼Œç„¶åè°ƒç”¨http server api</span>
NAMESPACE<span style=color:#f92672>=</span>your-rogue-namespace
kubectl proxy &amp;
kubectl get namespace $NAMESPACE -o json |jq <span style=color:#e6db74>&#39;.spec = {&#34;finalizers&#34;:[]}&#39;</span> &gt;temp.json
curl -k -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -X PUT --data-binary @temp.json 127.0.0.1:8001/api/v1/namespaces/$NAMESPACE/finalize

<span style=color:#75715e># ç›´æ¥è°ƒç”¨ï¼Œå°†ä¸Šè¿°jsonå†…å®¹çš„finalizersæ•°ç»„ç½®ä¸ºç©ºï¼Œä¿å­˜ä¸º default-mem-example.jsonï¼Œ è°ƒç”¨</span>
 k replace --raw <span style=color:#e6db74>&#34;/api/v1/namespaces/default-mem-example/finalize&#34;</span> -f default-mem-example.json
<span style=color:#75715e># å†æŸ¥çœ‹ç©ºé—´æ—¶ï¼Œæ­¤ç©ºé—´è¢«å½»åº•åˆ é™¤</span>
</code></pre></div><p>å…¶ä»–èµ„æºç±»ä¼¼</p>
<h2 id=start-over>start over</h2>
<h3 id=wsl2-æ—¶é—´åŒæ­¥>wsl2 æ—¶é—´åŒæ­¥</h3>
<p>æŒ‰ç…§<a href=https://auth0.com/blog/kubernetes-tutorial-step-by-step-introduction-to-basic-concepts/>Kubernetes Tutorial - Step by Step Introduction to Basic Concepts</a>ä»‹ç»åœ¨DOä¸Šåˆ›å»ºå…è´¹çš„k8sé›†ç¾¤ï¼Œåœ¨wsl2é‡Œè¿›è¡Œè®¿é—®æ—¶æç¤ºé”™è¯¯ï¼š<code>Unable to connect to the server: x509: certificate has expired or is not yet valid: current time 2021-11-09T02:59:51+08:00 is before 2021-11-09T07:47:25Z</code>æŸ¥çœ‹æœ¬åœ°æ—¶é—´ï¼Œæ˜¾ç¤ºæ¯”å®é™…å®é™…æ…¢</p>
<p>æ‰§è¡Œ<code>sudo hwclock -s </code>åŒæ­¥æ—¶é—´ä¾ç„¶æ²¡æœ‰å˜åŒ–ï¼Œå®˜æ–¹<a href=https://github.com/microsoft/WSL/issues/4149>issue 4149</a>ä¸­æä¾›äº†ä¸´æ—¶è§£å†³æ–¹æ¡ˆâ€”â€”netdateã€‚ç«‹å³ç”Ÿæ•ˆï¼Œä¸å½±å“ä»»ä½•è¿›ç¨‹</p>
<pre tabindex=0><code># æŒ‰ç…§ntpdate set the date and time via  Network Time Protocol (NTP)
sudo apt install ntpdate
# åŒæ­¥æ—¶é—´
sudo ntpdate -sb time.nist.gov
# æˆ–æ‰§è¡Œ
sudo ntpdate time.windows.com

myu@Gebitang:~$ sudo ntpdate time.windows.com
 9 Nov 16:09:43 ntpdate[1727]: step time server 52.231.114.183 offset 46499.066385 sec
</code></pre><p>åŒæ­¥æ—¶é—´ä¹‹åï¼Œå¯ä»¥è·Ÿé›†ç¾¤æ­£å¸¸äº¤äº’</p>
<h3 id=kubernetes-tutorial>Kubernetes Tutorial</h3>
<p>ä¸Šé¢æåˆ°çš„æ–‡ç« æœ‰ç‚¹è€ï¼Œé‡åˆ°çš„é—®é¢˜è®°å½•ä¸€ä¸‹â€”â€”</p>
<ul>
<li>é€šè¿‡promote codeæ³¨å†ŒDOéœ€è¦æ‰‹åŠ¨æäº¤ä¸ªticketï¼Œå¦åˆ™æ— æ³•åˆ›å»ºk8sé›†ç¾¤ï¼Œæç¤ºdropletè¶…é™</li>
<li>éƒ¨ç½²<code>NGINX ingress controller</code>çš„yamlæ–‡ä»¶åœ°å€å·²å¤±æ•ˆï¼Œå‚è€ƒ<a href=https://kubernetes.github.io/ingress-nginx/deploy/#digital-ocean>ingress-nginx</a>ä¸­çš„è¯´æ˜ï¼Œä½¿ç”¨<code>https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.0.4/deploy/static/provider/do/deploy.yaml</code>æ–‡ä»¶</li>
</ul>
<pre tabindex=0><code>myu@Gebitang:~$ k get pods -n ingress-nginx
NAME                                        READY   STATUS      RESTARTS   AGE
ingress-nginx-admission-create-n2dgj        0/1     Completed   0          87s
ingress-nginx-admission-patch-jldqd         0/1     Completed   2          86s
ingress-nginx-controller-5c8d66c76d-fgvpb   1/1     Running     0          90s
</code></pre><ul>
<li>æœ€ç»ˆéƒ¨ç½²å®Œserviceä¹‹åï¼Œè·å–å¤–ç½‘ipçš„æ­¥éª¤ä¹Ÿå¤±æ•ˆäº†ï¼Œé€šè¿‡<code>k get svc -n ingress-nginx</code>å¯ä»¥çœ‹åˆ°å¤–ç½‘ipåœ°å€ï¼Œå°½ç®¡è®¿é—®æœåŠ¡æ—¶æç¤º404ï¼Œè‡³å°‘è¡¨ç¤ºnginxå¯åŠ¨èµ·æ¥äº†</li>
</ul>
<h3 id=k8sä¸­çš„crdå¼€å‘>K8Sä¸­çš„CRDå¼€å‘</h3>
<p>CRD: <code>CustomResourceDefinition</code>, Custom code that defines a resource to add to your Kubernetes API server without building a complete custom server.</p>
<p><a href=http://bingerambo.com/posts/2021/05/k8s%E4%B8%AD%E7%9A%84crd%E5%BC%80%E5%8F%91>2021-05-04ç‰ˆæœ¬</a>æµç¨‹ã€‚ä¾èµ–<a href=https://github.com/kubernetes/code-generator>code-generator</a>ï¼Œå®˜æ–¹ç¤ºä¾‹<a href=https://github.com/kubernetes/sample-controller>sample-controller</a>ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ<a href=http://ljchen.net/2019/06/14/K8s-client%E4%BB%A3%E7%A0%81%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90/>K8s Clientä»£ç è‡ªåŠ¨ç”Ÿæˆ</a></p>
<p>ä½¿ç”¨ä»£ç ç”Ÿæˆå™¨ç”Ÿæˆçš„apiå…¼å®¹æ ‡å‡†çš„k8s apiï¼Œæ“ä½œåŠ¨ä½œç›¸åŒã€‚</p>
<h3 id=setup-with-dashboard>setup with dashboard</h3>
<p><a href=https://www.downloadkubernetes.com/>download binary</a></p>
<p><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/>Install kubectl on Linux</a></p>
<p>å…³äºUIç®¡ç†ä½¿ç”¨çš„<a href=https://github.com/kubernetes/dashboard/tree/master/docs>kubernetes/dashboard</a>ï¼Œå‚è€ƒå…·ä½“çš„<a href=https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md>doc: creating sample user</a></p>
<p>å…³äºç”¨æˆ·çš„æ­¥éª¤â€”â€”</p>
<ul>
<li>åŸºäºRBACçš„æ–¹å¼åˆ›å»º<code>ServiceAccount</code></li>
<li>å°†åˆ›å»ºçš„SAè¿›è¡Œ<code>CluserRoleBinding</code></li>
</ul>
<p>ç¤ºä¾‹ä¸­å¦‚æœå°†namespaceæŒ‡å®šä¸º<code>cluser-admin</code>ï¼Œå°†æ‹¥æœ‰ç®¡ç†å‘˜æƒé™ã€‚(é€šè¿‡<code>k get clusterroles</code>æŸ¥çœ‹é›†ç¾¤ä¸­éƒ½æœ‰å“ªäº›è§’è‰²)</p>
<pre tabindex=0><code>chmod +x kubectl
mkdir -p ~/.local/bin/kubectl
mv ./kubectl ~/.local/bin/kubectl
# and then add ~/.local/bin/kubectl to $PATH
</code></pre><p>è‡ªåŠ¨å®ŒæˆEnable kubectl autocompletion</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>source &lt;<span style=color:#f92672>(</span>kubectl completion bash<span style=color:#f92672>)</span>
alias k<span style=color:#f92672>=</span>kubectl
complete -F __start_kubectl k

<span style=color:#75715e>#shellç”Ÿæ•ˆ</span>
echo <span style=color:#e6db74>&#39;source &lt;(kubectl completion bash)&#39;</span> &gt;&gt;~/.bashrc
echo <span style=color:#e6db74>&#39;alias k=kubectl&#39;</span> &gt;&gt;~/.bashrc
echo <span style=color:#e6db74>&#39;complete -F __start_kubectl k&#39;</span> &gt;&gt;~/.bashrc
</code></pre></div><p>ä½¿ç”¨<code>kind</code>åˆ›å»ºé›†ç¾¤ <a href=https://kind.sigs.k8s.io/docs/user/quick-start/>quick start</a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># åˆ›å»ºä¸€ä¸ª3èŠ‚ç‚¹é›†ç¾¤çš„é…ç½®æ–‡ä»¶</span>
cat <span style=color:#e6db74>&lt;&lt; EOF &gt; kind-3nodes.yaml
</span><span style=color:#e6db74>kind: Cluster
</span><span style=color:#e6db74>apiVersion: kind.x-k8s.io/v1alpha4
</span><span style=color:#e6db74>nodes:
</span><span style=color:#e6db74>  - role: control-plane
</span><span style=color:#e6db74>  - role: worker
</span><span style=color:#e6db74>  - role: worker
</span><span style=color:#e6db74>EOF</span>
<span style=color:#75715e># ä½¿ç”¨é…ç½®æ–‡ä»¶åˆ›å»ºæ–°çš„é›†ç¾¤</span>
kind create cluster --name wslkindmultinodes --config ./kind-3nodes.yaml
<span style=color:#75715e># è·å–é›†ç¾¤èŠ‚ç‚¹</span>
kubectl get nodes
<span style=color:#75715e># åˆ é™¤é›†ç¾¤</span>
kind delete cluster --name wslkindmultinodess
</code></pre></div><p>è·Ÿç€<a href=https://www.qikqiak.com/post/deploy-k8s-on-win-use-wsl2>æ¼”ç¤º</a>ç›´åˆ°éƒ¨ç½²ä¸‰ä¸ªèŠ‚ç‚¹çš„clusteréƒ½æ­£å¸¸ï¼Œå®‰è£…ä¸€ä¸ª Kubernetes Dashboardæ—¶(<code>kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.1/aio/deploy/recommended.yaml</code>)ï¼Œ<code>kubectl get all -n kubernetes-dashboard</code>å‘½ä»¤æ˜¾ç¤ºï¼Œä¸€ç›´å¤„äº"ContainerCreating"çŠ¶æ€ã€‚æ„Ÿè§‰åº”è¯¥æ˜¯æˆ‘æœ¬åœ°ç½‘ç»œåŸå› ï¼Ÿ <a href=https://github.com/kubernetes/dashboard/issues/2863>issue 2863</a></p>
<p>å¤šä¸ªé…ç½®æ–‡ä»¶åˆ‡æ¢<a href=https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/>Configure Access to Multiple Clusters</a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># online.config.yaml for pro, dev.config.yaml for dev</span>
kubectl config --kubeconfig<span style=color:#f92672>=</span>online.config.yaml view

<span style=color:#75715e># export</span>
export KUBECONFIG<span style=color:#f92672>=</span>$KUBECONFIG:$HOME/.kube/config
export KUBECONFIG_SAVED<span style=color:#f92672>=</span>$KUBECONFIG
kubectl config view
<span style=color:#75715e># clean up </span>
export KUBECONFIG<span style=color:#f92672>=</span>$KUBECONFIG_SAVED
</code></pre></div><pre tabindex=0><code>geb@Gebitang:~$ kubectl get all -n kubernetes-dashboard
NAME                                             READY   STATUS              RESTARTS   AGE
pod/dashboard-metrics-scraper-5594697f48-wgpst   0/1     ContainerCreating   0          14m
pod/kubernetes-dashboard-bc8f4fc6f-f2mqg         0/1     ContainerCreating   0          14m

NAME                                TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
service/dashboard-metrics-scraper   ClusterIP   10.96.21.147   &lt;none&gt;        8000/TCP   14m
service/kubernetes-dashboard        ClusterIP   10.96.173.37   &lt;none&gt;        443/TCP    14m

NAME                                        READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/dashboard-metrics-scraper   0/1     1            0           14m
deployment.apps/kubernetes-dashboard        0/1     1            0           14m

NAME                                                   DESIRED   CURRENT   READY   AGE
replicaset.apps/dashboard-metrics-scraper-5594697f48   1         1         0       14m
replicaset.apps/kubernetes-dashboard-bc8f4fc6f         1         1         0       14m

#  kubectl get pods --all-namespaces
NAMESPACE              NAME                                                      READY   STATUS              RESTARTS   AGE
kube-system            coredns-558bd4d5db-57bh5                                  1/1     Running             0          16m
kube-system            coredns-558bd4d5db-sfsfp                                  1/1     Running             0          16m
kube-system            etcd-wslkindmultinodes-control-plane                      1/1     Running             0          17m
kube-system            kindnet-2k9fg                                             1/1     Running             0          16m
kube-system            kindnet-ssl4j                                             1/1     Running             0          16m
kube-system            kindnet-z5mgq                                             1/1     Running             0          16m
kube-system            kube-apiserver-wslkindmultinodes-control-plane            1/1     Running             0          17m
kube-system            kube-controller-manager-wslkindmultinodes-control-plane   1/1     Running             1          17m
kube-system            kube-proxy-b4r8b                                          1/1     Running             0          16m
kube-system            kube-proxy-mwlms                                          1/1     Running             0          16m
kube-system            kube-proxy-smhm5                                          1/1     Running             0          16m
kube-system            kube-scheduler-wslkindmultinodes-control-plane            1/1     Running             1          17m
kubernetes-dashboard   dashboard-metrics-scraper-5594697f48-wgpst                0/1     ContainerCreating   0          15m
kubernetes-dashboard   kubernetes-dashboard-bc8f4fc6f-f2mqg                      0/1     ContainerCreating   0          15m
local-path-storage     local-path-provisioner-547f784dff-dngw5                   1/1     Running             0          16m
</code></pre><p>éœ€è¦å…ˆå®‰è£…ç½‘ç»œâ€”â€”</p>
<p><a href=https://github.com/kubernetes/dashboard/issues/2863#issuecomment-368785304>å‚è€ƒè¿™ä¸ªcomment</a></p>
<pre tabindex=0><code># å¯ä»¥å°†urlå†…å®¹ä¿å­˜åˆ°æ–‡ä»¶è¿›è¡Œæ‰§è¡Œ
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/k8s-manifests/kube-flannel-rbac.yml
</code></pre><p>æ‰§è¡Œä¹‹åï¼Œ<code>kubectl get all -n kubernetes-dashboard</code>å¯ä»¥çœ‹åˆ°å¯¹åº”çš„podéƒ½æ­£å¸¸è¿è¡Œèµ·æ¥äº†</p>
<pre tabindex=0><code>geb@Gebitang:~$ kubectl get all -n kubernetes-dashboard
NAME                                             READY   STATUS    RESTARTS   AGE
pod/dashboard-metrics-scraper-5594697f48-wgpst   1/1     Running   0          33m
pod/kubernetes-dashboard-bc8f4fc6f-f2mqg         1/1     Running   0          33m

NAME                                TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
service/dashboard-metrics-scraper   ClusterIP   10.96.21.147   &lt;none&gt;        8000/TCP   33m
service/kubernetes-dashboard        ClusterIP   10.96.173.37   &lt;none&gt;        443/TCP    33m

NAME                                        READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/dashboard-metrics-scraper   1/1     1            1           33m
deployment.apps/kubernetes-dashboard        1/1     1            1           33m

NAME                                                   DESIRED   CURRENT   READY   AGE
replicaset.apps/dashboard-metrics-scraper-5594697f48   1         1         1       33m
replicaset.apps/kubernetes-dashboard-bc8f4fc6f         1         1         1       33m
</code></pre><p>proxyå¯åŠ¨åï¼Œä½¿ç”¨å¦‚ä¸‹æ–¹å¼è·å–tokenï¼Œ</p>
<pre tabindex=0><code># åˆ›å»ºä¸€ä¸ªæ–°çš„ ServiceAccount
kubectl apply -f - &lt;&lt;EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kubernetes-dashboard
EOF
# å°†ä¸Šé¢çš„ SA ç»‘å®šåˆ°ç³»ç»Ÿçš„ cluster-admin è¿™ä¸ªé›†ç¾¤è§’è‰²ä¸Š
kubectl apply -f - &lt;&lt;EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kubernetes-dashboard
EOF

# ----------actual result-------
geb@Gebitang:~$ kubectl apply -f - &lt;&lt;EOF
&gt; apiVersion: v1
&gt; kind: ServiceAccount
etadata:&gt; metadata:
&gt;   name: admin-user
namespac&gt;   namespace: kubernetes-dashboard
&gt; EOF
serviceaccount/admin-user created
geb@Gebitang:~$ kubectl apply -f - &lt;&lt;EOF
iVersio&gt; apiVersion: rbac.authorization.k8s.io/v1
&gt; kind: ClusterRoleBinding
&gt; metadata:
&gt;   name: admin-user
&gt; roleRef:
&gt;   apiGroup: rbac.authorization.k8s.io
&gt;   kind: ClusterRole
&gt;   name: cluster-admin
&gt; subjects:
&gt; - kind: ServiceAccount
&gt;   name: admin-user
&gt;   namespace: kubernetes-dashboard
&gt; EOF
clusterrolebinding.rbac.authorization.k8s.io/admin-user created
geb@Gebitang:~$
geb@Gebitang:~$ kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk '{print $1}')
Name:         admin-user-token-d4mkv
Namespace:    kubernetes-dashboard
Labels:       &lt;none&gt;
Annotations:  kubernetes.io/service-account.name: admin-user
              kubernetes.io/service-account.uid: b66a6322-81a3-4bec-af6a-c329c4702ef8

Type:  kubernetes.io/service-account-token

Data
====
ca.crt:     1066 bytes
namespace:  20 bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IjdnaktTQ2Nuc1RfbGhWaWs3NHYtRzF2VFhIU2ZTX3g4aFBHUkNfYkROOU0ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWQ0bWt2Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJiNjZhNjMyMi04MWEzLTRiZWMtYWY2YS1jMzI5YzQ3MDJlZjgiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.pSiZrLue_t9R8qXN7Dm6jaOblVnLr_qI0NvkL25N3TB78rvR3O2zIzZ0cJ5ylvl7hdxIRXoKQxZUvY8cCeFRosBdGp_gaevd_33vlLNfcj0UM3x_9IQeS4cqPlI0EkWcrVXbPbQQyCLKBSgaaCNQrijtiQXUgaK2eLh8FCmvFIIE5U2vs-GqlmTy1YNpGr28WjtML-bFvQIsL7BpZieWzBNb7VfnsNMRPjpmUUE6iurVApwZSNTesFcKQP-dW7trN0B8hI7SllRMN64rfUnNwZX58eI5esgicQ2STJ64WkqTRYbGs1up__Iz_xvoRYXQq4bN_SSVnCnLOtf8jpVuyA
geb@Gebitang:~$
</code></pre><p>è®¿é—®<code>http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</code>é€‰æ‹©tokenæ–¹å¼ï¼Œå°†ä¸Šé¢è·å–åˆ°çš„tokenè¾“å…¥åï¼Œå°±å¯ä»¥çœ‹åˆ°UIé¡µé¢</p>
<p>åˆ é™¤é›†ç¾¤â€”â€”</p>
<pre tabindex=0><code># æŸ¥æ‰¾é›†ç¾¤
kind get cluster 
# åˆ é™¤ç°åœ¨çš„é›†ç¾¤
kind delete cluster --name wslkindmultinodes
</code></pre><h2 id=archive>archive</h2>
<h3 id=æœ¯è¯­åˆ—è¡¨>æœ¯è¯­åˆ—è¡¨</h3>
<div class=pure-g>
<div class=pure-u-1-1>
<div style="padding:0 .2em">
<a href=https://time.geekbang.org/column/article/23132 target=_blank>
<img class=pure-img-responsive src=https://static001.geekbang.org/resource/image/8e/67/8ee9f2fa987eccb490cfaa91c6484f67.png alt title=Kubernetesé¡¹ç›®æ¶æ„>
</a>
</div>
</div>
</div>
<ul>
<li>OCI: Open Container Initiative</li>
<li>CNI: Container Network Interface</li>
<li>CRI: Container Runtime Interface</li>
<li>CSI: Container Storage Interface</li>
</ul>
<p>ä½¿ç”¨ç¯å¢ƒWindowsã€‚</p>
<h3 id=wsl2--kubernetes>WSL2 + Kubernetes</h3>
<p><a href=https://www.qikqiak.com/post/deploy-k8s-on-win-use-wsl2>åœ¨ Windows ä¸‹ä½¿ç”¨ WSL2 æ­å»º Kubernetes é›†ç¾¤</a></p>
<ul>
<li>å®‰è£…å•†åº—é‡Œçš„<code>windows terminal</code></li>
<li>æ›´æ–°ubuntuçš„è½¯ä»¶æº</li>
</ul>
<pre tabindex=0><code>cp /etc/apt/sources.list /etc/apt/sources.list.bak
root@k8s:~# echo &quot;deb http://mirrors.aliyun.com/ubuntu/ focal main restricted
deb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted
deb http://mirrors.aliyun.com/ubuntu/ focal universe
deb http://mirrors.aliyun.com/ubuntu/ focal-updates universe
deb http://mirrors.aliyun.com/ubuntu/ focal multiverse
deb http://mirrors.aliyun.com/ubuntu/ focal-updates multiverse
deb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted
deb http://mirrors.aliyun.com/ubuntu/ focal-security universe
deb http://mirrors.aliyun.com/ubuntu/ focal-security multiverse&quot; &gt; /etc/apt/sources.list
</code></pre><ul>
<li>kindå¯ä»¥ä»githubä¸Šä¸‹è½½åæ‰‹åŠ¨å®‰è£…â€”â€”æœ¬èº«æ˜¯goç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶</li>
<li>ä½†kindå®‰è£…kubernetesé›†ç¾¤æ—¶ä½¿ç”¨çš„æ˜¯ç¼–è¯‘å‘å¸ƒåœ¨hub.docker.comä¸Šçš„é•œåƒï¼ŒWSL2é‡Œé‡åˆ°ç½‘ç»œé—®é¢˜</li>
</ul>
<blockquote>
<p>This will bootstrap a Kubernetes cluster using a pre-builtÂ <a href=https://kind.sigs.k8s.io/docs/design/node-image>node image</a>. Prebuilt images are hosted at<a href=https://hub.docker.com/r/kindest/node/><code>kindest/node</code></a></p>
</blockquote>
<pre tabindex=0><code>root@Gebitang:/home/geb# kind create cluster --name wslk8s
Creating cluster &quot;wslk8s&quot; ...
 âœ“ Ensuring node image (kindest/node:v1.21.1) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
Set kubectl context to &quot;kind-wslk8s&quot;
You can now use your cluster with:

kubectl cluster-info --context kind-wslk8s

Thanks for using kind! ğŸ˜Š
</code></pre><p>é‡æ–°ä½¿ç”¨<code>kubeadm</code>è¿›è¡Œå®‰è£…ï¼š</p>
<ul>
<li>éœ€è¦å…ˆå°†apt-key.gpgè¯ä¹¦å¯¼å…¥<code>curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -</code>ã€‚å¯ä»¥å…ˆå°†æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°ï¼Œç„¶å<code>cat apt-get.gpg | apt-key add -</code></li>
<li>æ·»åŠ é•œåƒæºåˆ°åˆ—è¡¨ï¼šåœ¨<code>/etc/apt/sources.list.d/</code>ç›®å½•ä¸‹åˆ›å»º<code>kubernetes.list</code>æ–‡ä»¶ï¼Œå†…å®¹ä¸º<code>deb http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial main</code></li>
<li>æ‰§è¡Œ<code>apt-get update && apt-get install -y kubeadm</code></li>
</ul>
<p>æ‰§è¡Œ<code>kubeadm version</code>è¿”å›ä¿¡æ¯ã€‚</p>
<h3 id=errors-were-encountered-while-processing--ubuntu-advantage-tools>Errors were encountered while processing: ubuntu-advantage-tools</h3>
<p>ubuntu20.04æ‰§è¡Œ<code>apt-get upgrade</code>æ—¶é‡åˆ°ç±»ä¼¼ä¸Šé¢çš„é—®é¢˜ï¼Œçœ‹èµ·æ¥æ˜¯ä¸ª<a href=https://bugs.launchpad.net/ubuntu/+source/ubuntu-advantage-tools/+bug/1938097>bug</a>ï¼Œå®˜æ–¹æç¤ºä¿®å¤æ–¹å¼ï¼š</p>
<ul>
<li>ç¼–è¾‘<code>/var/lib/dpkg/info/ubuntu-advantage-tools.postinst</code></li>
<li>æ‰§è¡Œ<code>dpkg --configure -a</code></li>
</ul>
<pre tabindex=0><code>I think the problem is in the postinst script, line 295:

    cloud_id=&quot;&quot;
    if command -v &quot;cloud-id&quot; &gt; /dev/null ; then
      cloud_id=$(cloud-id)
    fi

The third line should rather be:

      cloud_id=$(cloud-id || true)
</code></pre><p>æ ¹æ®<a href=https://edu.aliyun.com/roadmap/cloudnative>äº‘åŸç”ŸæŠ€æœ¯åŸºç¡€</a>çš„<a href=https://edu.aliyun.com/lesson_1651_16894>ç¬¬ä¸‰è¯¾çš„demo</a></p>
<h3 id=å‰æç¯å¢ƒ>å‰æç¯å¢ƒ</h3>
<p>ä¸‰ä»¶å¥—ï¼šVirturalBoxã€kubectlã€minikubeã€‚</p>
<ul>
<li>
<p>å®‰è£… VirtualBoxï¼šÂ <a href=https://www.virtualbox.org/wiki/Downloads>https://www.virtualbox.org/wiki/Downloads</a></p>
</li>
<li>
<p>å®‰è£…<a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-on-windows>kubectl on windows</a></p>
</li>
</ul>
<p>ä¸‹è½½ã€æ·»åŠ PATHã€éªŒè¯ç‰ˆæœ¬</p>
<ol>
<li>
<p>Download the latest release v1.18.0 fromÂ <a href=https://storage.googleapis.com/kubernetes-release/release/v1.18.0/bin/windows/amd64/kubectl.exe>this link</a>.</p>
<p>Or if you haveÂ <code>curl</code>Â installed, use this command:</p>
<pre tabindex=0><code>curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.18.0/bin/windows/amd64/kubectl.exe
</code></pre><p>To find out the latest stable version (for example, for scripting), take a look atÂ <a href=https://storage.googleapis.com/kubernetes-release/release/stable.txt>https://storage.googleapis.com/kubernetes-release/release/stable.txt</a>.</p>
</li>
<li>
<p>Add the binary in to your PATH.</p>
</li>
<li>
<p>Test to ensure the version ofÂ <code>kubectl</code>Â is the same as downloaded:</p>
<pre tabindex=0><code>kubectl version --client
</code></pre></li>
</ol>
<ul>
<li>å®‰è£…minikubeï¼Œ<a href=https://kubernetes.io/docs/tasks/tools/install-minikube/>åŸç”Ÿå®‰è£…</a>ï¼Œ<a href=https://developer.aliyun.com/article/221687>aliyun: Minikube - Kubernetesæœ¬åœ°å®éªŒç¯å¢ƒ</a></li>
</ul>
<p>å…ˆè¿›è¡Œç³»ç»Ÿæ£€æµ‹<code>systeminfo</code></p>
<pre tabindex=0><code>Hyper-V Requirements:     A hypervisor has been detected. Features required for Hyper-V will not be displayed.
Hyper-V è¦æ±‚:     å·²æ£€æµ‹åˆ°è™šæ‹Ÿæœºç›‘æ§ç¨‹åºã€‚å°†ä¸æ˜¾ç¤º Hyper-V æ‰€éœ€çš„åŠŸèƒ½ã€‚
</code></pre><hr>
<p>å¯åŠ¨å‘½ä»¤ï¼š <code>minikube start --driver virtualbox</code></p>
<pre tabindex=0><code>D:\&gt;minikube start --driver=virtualbox
* Microsoft Windows 10 Education 10.0.18363 Build 18363 ä¸Šçš„ minikube v1.12.3
* æ ¹æ®ç°æœ‰çš„é…ç½®æ–‡ä»¶ä½¿ç”¨ virtualbox é©±åŠ¨ç¨‹åº
* Starting control plane node minikube in cluster minikube
* Creating virtualbox VM (CPUs=4, Memory=6000MB, Disk=20000MB) ...
! StartHost failed, but will try again: creating host: create: precreate: This computer is running Hyper-V. VirtualBox won't boot a 64bits VM when Hyper-V is activated. Either use Hyper-V as a driver, or disable the Hyper-V hypervisor. (To skip this check, use --virtualbox-no-vtx-check)
* Creating virtualbox VM (CPUs=4, Memory=6000MB, Disk=20000MB) ...
* Failed to start virtualbox VM. &quot;minikube start&quot; may fix it: creating host: create: precreate: This computer is running Hyper-V. VirtualBox won't boot a 64bits VM when Hyper-V is activated. Either use Hyper-V as a driver, or disable the Hyper-V hypervisor. (To skip this check, use --virtualbox-no-vtx-check)
*
E0821 17:24:38.091674   11324 exit.go:76] &amp;{ID:VBOX_HYPERV_64_BOOT Err:This computer is running Hyper-V. VirtualBox won't boot a 64bits VM when Hyper-V is activated. Either use Hyper-V as a driver, or disable the Hyper-V hypervisor. (To skip this check, use --virtualbox-no-vtx-check)
precreate
k8s.io/minikube/pkg/minikube/machine.(*LocalClient).Create
        /app/pkg/minikube/machine/client.go:225
k8s.io/minikube/pkg/minikube/machine.timedCreateHost.func2
        /app/pkg/minikube/machine/start.go:188
runtime.goexit
        /usr/local/go/src/runtime/asm_amd64.s:1373
create
k8s.io/minikube/pkg/minikube/machine.timedCreateHost
        /app/pkg/minikube/machine/start.go:197
k8s.io/minikube/pkg/minikube/machine.createHost
        /app/pkg/minikube/machine/start.go:163
k8s.io/minikube/pkg/minikube/machine.StartHost
        /app/pkg/minikube/machine/start.go:86
k8s.io/minikube/pkg/minikube/node.startHost
        /app/pkg/minikube/node/start.go:401
k8s.io/minikube/pkg/minikube/node.startMachine
        /app/pkg/minikube/node/start.go:345
k8s.io/minikube/pkg/minikube/node.Provision
        /app/pkg/minikube/node/start.go:234
k8s.io/minikube/cmd/minikube/cmd.provisionWithDriver
        /app/cmd/minikube/cmd/start.go:275
k8s.io/minikube/cmd/minikube/cmd.runStart
        /app/cmd/minikube/cmd/start.go:169
github.com/spf13/cobra.(*Command).execute
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:846
github.com/spf13/cobra.(*Command).ExecuteC
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:950
github.com/spf13/cobra.(*Command).Execute
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:887
k8s.io/minikube/cmd/minikube/cmd.Execute
        /app/cmd/minikube/cmd/root.go:106
main.main
        /app/cmd/minikube/main.go:71
runtime.main
        /usr/local/go/src/runtime/proc.go:203
runtime.goexit
        /usr/local/go/src/runtime/asm_amd64.s:1373
creating host
k8s.io/minikube/pkg/minikube/machine.createHost
        /app/pkg/minikube/machine/start.go:164
k8s.io/minikube/pkg/minikube/machine.StartHost
        /app/pkg/minikube/machine/start.go:86
k8s.io/minikube/pkg/minikube/node.startHost
        /app/pkg/minikube/node/start.go:401
k8s.io/minikube/pkg/minikube/node.startMachine
        /app/pkg/minikube/node/start.go:345
k8s.io/minikube/pkg/minikube/node.Provision
        /app/pkg/minikube/node/start.go:234
k8s.io/minikube/cmd/minikube/cmd.provisionWithDriver
        /app/cmd/minikube/cmd/start.go:275
k8s.io/minikube/cmd/minikube/cmd.runStart
        /app/cmd/minikube/cmd/start.go:169
github.com/spf13/cobra.(*Command).execute
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:846
github.com/spf13/cobra.(*Command).ExecuteC
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:950
github.com/spf13/cobra.(*Command).Execute
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:887
k8s.io/minikube/cmd/minikube/cmd.Execute
        /app/cmd/minikube/cmd/root.go:106
main.main
        /app/cmd/minikube/main.go:71
runtime.main
        /usr/local/go/src/runtime/proc.go:203
runtime.goexit
        /usr/local/go/src/runtime/asm_amd64.s:1373
Failed to start host
k8s.io/minikube/pkg/minikube/node.startMachine
        /app/pkg/minikube/node/start.go:347
k8s.io/minikube/pkg/minikube/node.Provision
        /app/pkg/minikube/node/start.go:234
k8s.io/minikube/cmd/minikube/cmd.provisionWithDriver
        /app/cmd/minikube/cmd/start.go:275
k8s.io/minikube/cmd/minikube/cmd.runStart
        /app/cmd/minikube/cmd/start.go:169
github.com/spf13/cobra.(*Command).execute
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:846
github.com/spf13/cobra.(*Command).ExecuteC
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:950
github.com/spf13/cobra.(*Command).Execute
        /go/pkg/mod/github.com/spf13/cobra@v1.0.0/command.go:887
k8s.io/minikube/cmd/minikube/cmd.Execute
        /app/cmd/minikube/cmd/root.go:106
main.main
        /app/cmd/minikube/main.go:71
runtime.main
        /usr/local/go/src/runtime/proc.go:203
runtime.goexit
        /usr/local/go/src/runtime/asm_amd64.s:1373 Advice:VirtualBox and Hyper-V are having a conflict. Use '--driver=hyperv' or disable Hyper-V using: 'bcdedit /set hypervisorlaunchtype off' URL: Issues:[4051 4783] ShowIssueLink:false}
* [VBOX_HYPERV_64_BOOT] error provisioning host Failed to start host: creating host: create: precreate: This computer is running Hyper-V. VirtualBox won't boot a 64bits VM when Hyper-V is activated. Either use Hyper-V as a driver, or disable the Hyper-V hypervisor. (To skip this check, use --virtualbox-no-vtx-check)
* å»ºè®®ï¼šVirtualBox and Hyper-V are having a conflict. Use '--driver=hyperv' or disable Hyper-V using: 'bcdedit /set hypervisorlaunchtype off'
* ç›¸å…³é—®é¢˜ï¼š
  - https://github.com/kubernetes/minikube/issues/4051
  - https://github.com/kubernetes/minikube/issues/4783

</code></pre><p>æŠ¥é”™ä¿¡æ¯è¿˜æ˜¯å¾ˆæ¸…æ¥šï¼Œè¿è¡Œæ—¶å†²çªï¼š</p>
<ul>
<li>ä½¿ç”¨ç®¡ç†å‘˜æƒé™æ‰§è¡Œ<code>bcdedit /set hypervisorlaunchtype off</code>ï¼ŒæˆåŠŸåï¼Œè¿˜æ˜¯æç¤ºç›¸åŒçš„é—®é¢˜ã€‚</li>
<li>ä½¿ç”¨<code>--virtualbox-no-vtx-check</code> æç¤ºè¿™ä¸ª<code>Error: unknown flag: --virtualbox-no-vtx-check</code> å¯ä»¥See <code>minikube start --help' for usage.</code></li>
</ul>
<p>æœç„¶ï¼Œç°åœ¨çš„å‚æ•°æ˜¯<code>--no-vtx-check=true</code>ã€‚æ‰€ä»¥å®Œæ•´çš„å‚æ•°åº”è¯¥æ˜¯<code>minikube start --driver=virtualbox --no-vtx-check=true</code></p>
<p>ä¸å¹¸çš„æ—¶ï¼Œè¿˜æ˜¯é‡åˆ°é—®é¢˜äº†</p>
<pre tabindex=0><code>PS D:\&gt; minikube start --driver=virtualbox --no-vtx-check=true
* Microsoft Windows 10 Education 10.0.18363 Build 18363 ä¸Šçš„ minikube v1.12.3
* æ ¹æ®ç°æœ‰çš„é…ç½®æ–‡ä»¶ä½¿ç”¨ virtualbox é©±åŠ¨ç¨‹åº
* Starting control plane node minikube in cluster minikube
* Creating virtualbox VM (CPUs=4, Memory=6000MB, Disk=20000MB) ...
* æ­£åœ¨ Docker 19.03.12 ä¸­å‡†å¤‡ Kubernetes v1.18.3â€¦
* Unable to load cached images: loading cached images: transferring cached image: sudo test -d /var/lib/minikube/images &amp;&amp; sudo scp -t /var/lib/minikube/images &amp;&amp; sudo touch -d &quot;2020-08-21 17:31:20.5418176 +0800&quot; /var/lib/minikube/images/etcd_3.4.3-0: wait: remote command exited without exit status or exit signal
output:
...
stdout:

stderr:
fatal error: index out of range
runtime: panic before malloc heap initialized

</code></pre><p>æ‰§è¡Œ<code>bcdedit /set hypervisorlaunchtype off</code>ä¹‹åå‡ºç°dockeræ— æ³•å¯åŠ¨æƒ…å†µï¼Ÿç®¡ç†å‘˜æƒé™æ‰§è¡Œ<code>bcdedit /Set {current} hypervisorlaunchtype auto</code>æ¢å¤åˆå§‹å€¼ï¼Œæ‰§è¡Œ<code>bcdedit</code>å¯çœ‹åˆ°å…¨éƒ¨é…ç½®ä¿¡æ¯ã€‚</p>
<p>è‡ªåŠ¨æç¤ºé“¾æ¥ä¸º<a href=https://docs.docker.com/docker-for-windows/troubleshoot/#virtualization-must-be-enabled>VIRTUALIZATION MUST BE ENABLED</a>ï¼Œä½†æ£€æŸ¥æ˜¯ç¬¦åˆè¦æ±‚çš„ã€‚é‡å¯åå†çœ‹å§ã€‚æ¥ç€å…ˆå¾€ä¸‹å­¦è¯¾ç¨‹ã€‚</p>
<div class="prev-next-post pure-g">
<div class=pure-u-1-24 style=text-align:left>
<a href=http://gebitang.com/post/how/open-grok/><i class="fa fa-chevron-left"></i></a>
</div>
<div class=pure-u-10-24>
<nav class=prev>
<a href=http://gebitang.com/post/how/open-grok/>éƒ¨ç½²éªŒè¯OpenGrok</a>
</nav>
</div>
<div class=pure-u-2-24>
&nbsp;
</div>
<div class=pure-u-10-24>
<nav class=next>
<a href=http://gebitang.com/post/daily-updates/>Daily Playground</a>
</nav>
</div>
<div class=pure-u-1-24 style=text-align:right>
<a href=http://gebitang.com/post/daily-updates/><i class="fa fa-chevron-right"></i></a>
</div>
</div>
<div id=disqus_thread></div>
<script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='gebitang',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
</div>
</div>
<script src=http://gebitang.com/js/ui.js></script>
<script src=http://gebitang.com/js/menus.js></script>
<script>window.location.hostname!="localhost"&&(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-34303694-1','auto'),ga('send','pageview'))</script>
<button onclick=topFunction() id=myBtn title="Go to top">Top</button>
</body>
</html>