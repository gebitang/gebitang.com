<!doctype html><html xmlns:wb=http://open.weibo.com/wb lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content>
<meta name=generator content="Hugo 0.91.2">
<title>STF之复用ADB一 &#183; 戈壁堂</title>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!-->
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=http://gebitang.com/css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!-->
<link rel=stylesheet href=http://gebitang.com/css/side-menu.css><!--<![endif]-->
<link rel=stylesheet href=http://gebitang.com/css/blackburn.css>
<link rel=stylesheet href=https://use.fontawesome.com/releases/v5.9.0/css/all.css>
<link href="https://fonts.googleapis.com/css?family=Raleway" rel=stylesheet type=text/css>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css>
<script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js></script>
<script>hljs.initHighlightingOnLoad()</script>
<link rel="shortcut icon" href=http://gebitang.com/img/favicon.ico type=image/x-icon>
<link rel=stylesheet href=http://gebitang.com/css/my.css>
<script src=http://gebitang.com/js/my.js></script>
</head>
<body>
<div id=layout>
<a href=#menu id=menuLink class=menu-link>
<span></span>
</a>
<div id=menu>
<a class="pure-menu-heading brand" href=http://gebitang.com/>Gebitang</a>
<div class=pure-menu>
<ul class=pure-menu-list>
<li class=pure-menu-item>
<a class=pure-menu-link href=http://gebitang.com/><i class="fa fa-home fa-fw"></i>Home</a>
</li>
<li class=pure-menu-item>
<a class=pure-menu-link href=http://gebitang.com/post/><i class="fa fa-list fa-fw"></i>Posts</a>
</li>
<li class=pure-menu-item>
<a class=pure-menu-link href=http://gebitang.com/about/><i class="fa fa-user fa-fw"></i>About</a>
</li>
<li class=pure-menu-item>
<a class=pure-menu-link href=http://gebitang.com/contact/><i class="fa fa-phone fa-fw"></i>Contact</a>
</li>
<li class=pure-menu-item>
<a class=pure-menu-link href=http://gebitang.com/tags/><i class="fa fa-tags fa-fw"></i>Tags</a>
</li>
<li class=pure-menu-item>
<a class=pure-menu-link href=http://gebitang.com/topics/><i class="fa fa-folder fa-fw"></i>Topics</a>
</li>
</ul>
</div>
<div class="pure-menu social">
<ul class=pure-menu-list>
</ul>
</div>
<div>
<div class=small-print>
<small>
<a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt=知识共享许可协议 style=border-width:0 src=https://i.creativecommons.org/l/by/4.0/80x15.png></a><br>本<span xmlns:dct=http://purl.org/dc/terms/ href=http://purl.org/dc/dcmitype/Text rel=dct:type>作品</span>由<a xmlns:cc=http://creativecommons.org/ns# href=http://gebitang.com property="cc:attributionName" rel=cc:attributionurl>&nbsp;Gebitang&nbsp;&nbsp;</a>采用<a rel=license href=http://creativecommons.org/licenses/by/4.0/>知识共享署名 4.0 国际许可协议</a>进行许可&nbsp;&copy; 2018
</small>
</div>
<div class=small-print>
<small></small>
</div>
<div class=small-print>
<small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small>
</div>
<div style=display:none>
<div class=small-print>
<small>
<wb:follow-button uid=2446212465 type=red_1 width=67 height=24></wb:follow-button>
</small>
</div>
</div>
</div>
</div>
<div id=main>
<div class=header>
<h1>STF之复用ADB一</h1>
<h2></h2>
</div>
<div class=content>
<div class=post-meta>
<div>
<i class="fa fa-calendar fa-fw"></i>
<time>2020-03-07</time>
</div>
<div>
<i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=http://gebitang.com/topics/jiansh>jiansh</a>&nbsp;/
<a class=post-taxonomy-topic href=http://gebitang.com/topics/stf>STF</a>
</div>
<div>
<i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=http://gebitang.com/tags/jiansh>jiansh</a>
</div>
</div>
<nav id=TableOfContents></nav>
<p><a href=https://www.jianshu.com/p/02a561879ef6>link on JianShu</a></p>
<p>假如还有一个Java应用也需要连接、管理设备，是否可以和STF共享？</p>
<p>在重温了官方说明以及google之后，以下方案应该是可行的：</p>
<ol>
<li>PC上使用相同的adb（相当于使用相同的adb server）</li>
<li>Java端使用设备时，通知STF申请占用此设备——基于条件1，可以利用serial进行识别设备</li>
<li>STF和Java应用都只是做为adb client</li>
</ol>
<p>重温了一下<a href=https://developer.android.com/studio/command-line/adb>adb官方说明</a>：</p>
<blockquote>
<p><strong>A client</strong>, which sends commands. The client runs on your development machine. You can invoke a client from a command-line terminal by issuing an adb command.
<strong>A daemon</strong> (<strong>adbd</strong>), which runs commands on a device. The daemon runs as a background process on each device.
<strong>A server</strong>, which manages communication between the client and the daemon. The server runs as a background process on your development machine.</p>
</blockquote>
<p><a href=https://android.googlesource.com/platform/system/core/+/master/adb/OVERVIEW.TXT>官方code说明 OVERVIEW</a></p>
<pre tabindex=0><code>Implementation notes regarding ADB.
I. General Overview:
The Android Debug Bridge (ADB) is used to:
- keep track of all Android devices and emulators instances
  connected to or running on a given host developer machine
- implement various control commands (e.g. &quot;adb shell&quot;, &quot;adb pull&quot;, etc.)
  for the benefit of clients (command-line users, or helper programs like
  DDMS). These commands are called 'services' in ADB.
As a whole, everything works through the following components:
  1. The ADB server
    This is a background process that runs on the host machine. Its purpose
    is to sense the USB ports to know when devices are attached/removed,
    as well as when emulator instances start/stop.
    It thus maintains a list of &quot;connected devices&quot; and assigns a 'state'
    to each one of them: OFFLINE, BOOTLOADER, RECOVERY or ONLINE (more on
    this below).
    The ADB server is really one giant multiplexing loop whose purpose is
    to orchestrate the exchange of data (packets, really) between clients,
    services and devices.
  2. The ADB daemon (adbd)
    The 'adbd' program runs as a background process within an Android device
    or emulated system. Its purpose is to connect to the ADB server
    (through USB for devices, through TCP for emulators) and provide a
    few services for clients that run on the host.
    The ADB server considers that a device is ONLINE when it has successfully
    connected to the adbd program within it. Otherwise, the device is OFFLINE,
    meaning that the ADB server detected a new device/emulator, but could not
    connect to the adbd daemon.
    The BOOTLOADER and RECOVERY states correspond to alternate states of
    devices when they are in the bootloader or recovery mode.
  3. The ADB command-line client
    The 'adb' command-line program is used to run adb commands from a shell
    or a script. It first tries to locate the ADB server on the host machine,
    and will start one automatically if none is found.
    Then, the client sends its service requests to the ADB server.
    Currently, a single 'adb' binary is used for both the server and client.
    this makes distribution and starting the server easier.
  4. Services
    There are essentially two kinds of services that a client can talk to.
    Host Services:
      These services run within the ADB Server and thus do not need to
      communicate with a device at all. A typical example is &quot;adb devices&quot;
      which is used to return the list of currently known devices and their
      states. They are a few other services though.
    Local Services:
      These services either run within the adbd daemon, or are started by
      it on the device. The ADB server is used to multiplex streams
      between the client and the service running in adbd. In this case
      its role is to initiate the connection, then of being a pass-through
      for the data.
II. Protocol details:
  1. Client &lt;-&gt; Server protocol:
    This details the protocol used between ADB clients and the ADB
    server itself. The ADB server listens on TCP:localhost:5037.
    A client sends a request using the following format:
        1. A 4-byte hexadecimal string giving the length of the payload
        2. Followed by the payload itself.
    For example, to query the ADB server for its internal version number,
    the client will do the following:
        1. Connect to tcp:localhost:5037
        2. Send the string &quot;000Chost:version&quot; to the corresponding socket
    The 'host:' prefix is used to indicate that the request is addressed
    to the server itself (we will talk about other kinds of requests later).
    The content length is encoded in ASCII for easier debugging.
    The server should answer a request with one of the following:
        1. For success, the 4-byte &quot;OKAY&quot; string
        2. For failure, the 4-byte &quot;FAIL&quot; string, followed by a
           4-byte hex length, followed by a string giving the reason
           for failure.
    Note that the connection is still alive after an OKAY, which allows the
    client to make other requests. But in certain cases, an OKAY will even
    change the state of the connection.
    For example, the case of the 'host:transport:&lt;serialnumber&gt;' request,
    where '&lt;serialnumber&gt;' is used to identify a given device/emulator; after
    the &quot;OKAY&quot; answer, all further requests made by the client will go
    directly to the corresponding adbd daemon.
    The file SERVICES.TXT lists all services currently implemented by ADB.
  2. Transports:
    An ADB transport models a connection between the ADB server and one device
    or emulator. There are currently two kinds of transports:
       - USB transports, for physical devices through USB
       - Local transports, for emulators running on the host, connected to
         the server through TCP
    In theory, it should be possible to write a local transport that proxies
    a connection between an ADB server and a device/emulator connected to/
    running on another machine. This hasn't been done yet though.
    
    Each transport can carry one or more multiplexed streams between clients
    and the device/emulator they point to. The ADB server must handle
    unexpected transport disconnections (e.g. when a device is physically
    unplugged) properly.
</code></pre>
<div class="prev-next-post pure-g">
<div class=pure-u-1-24 style=text-align:left>
<a href=http://gebitang.com/post/jiansh/stf/stf%E4%B9%8B%E5%AE%89%E8%A3%85%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98/><i class="fa fa-chevron-left"></i></a>
</div>
<div class=pure-u-10-24>
<nav class=prev>
<a href=http://gebitang.com/post/jiansh/stf/stf%E4%B9%8B%E5%AE%89%E8%A3%85%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98/>STF之安装失败问题</a>
</nav>
</div>
<div class=pure-u-2-24>
&nbsp;
</div>
<div class=pure-u-10-24>
<nav class=next>
<a href=http://gebitang.com/post/jiansh/stf/stf%E4%B9%8B%E4%BB%8Estf-local%E8%AF%B4%E5%BC%80%E5%8E%BB/>STF之从stf-local说开去</a>
</nav>
</div>
<div class=pure-u-1-24 style=text-align:right>
<a href=http://gebitang.com/post/jiansh/stf/stf%E4%B9%8B%E4%BB%8Estf-local%E8%AF%B4%E5%BC%80%E5%8E%BB/><i class="fa fa-chevron-right"></i></a>
</div>
</div>
<div id=disqus_thread></div>
<script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='gebitang',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
</div>
</div>
<script src=http://gebitang.com/js/ui.js></script>
<script src=http://gebitang.com/js/menus.js></script>
<script>window.location.hostname!="localhost"&&(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-34303694-1','auto'),ga('send','pageview'))</script>
<button onclick=topFunction() id=myBtn title="Go to top">Top</button>
</body>
</html>