<!doctype html><html xmlns:wb=http://open.weibo.com/wb lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.98.0"><title>Sonar实践问题记录(七)node版本排查 &#183; 戈壁堂</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=http://gebitang.com/css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=http://gebitang.com/css/side-menu.css><!--<![endif]--><link rel=stylesheet href=http://gebitang.com/css/blackburn.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.9.0/css/all.css><link href="https://fonts.googleapis.com/css?family=Raleway" rel=stylesheet type=text/css><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js></script>
<script>hljs.initHighlightingOnLoad()</script><link rel="shortcut icon" href=http://gebitang.com/img/favicon.ico type=image/x-icon><link rel=stylesheet href=http://gebitang.com/css/my.css><script src=http://gebitang.com/js/my.js></script></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><a class="pure-menu-heading brand" href=http://gebitang.com/>Gebitang</a><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/><i class="fa fa-home fa-fw"></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/post/><i class="fa fa-list fa-fw"></i>Posts</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/about/><i class="fa fa-user fa-fw"></i>About</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/contact/><i class="fa fa-phone fa-fw"></i>Contact</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/tags/><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/topics/><i class="fa fa-folder fa-fw"></i>Topics</a></li></ul></div><div class="pure-menu social"><ul class=pure-menu-list></ul></div><div><div class=small-print><small><a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt=知识共享许可协议 style=border-width:0 src=https://i.creativecommons.org/l/by/4.0/80x15.png></a><br>本<span xmlns:dct=http://purl.org/dc/terms/ href=http://purl.org/dc/dcmitype/Text rel=dct:type>作品</span>由<a xmlns:cc=http://creativecommons.org/ns# href=http://gebitang.com property="cc:attributionName" rel=cc:attributionurl>&nbsp;Gebitang&nbsp;&nbsp;</a>采用<a rel=license href=http://creativecommons.org/licenses/by/4.0/>知识共享署名 4.0 国际许可协议</a>进行许可&nbsp;&copy; 2018</small></div><div class=small-print><small></small></div><div class=small-print><small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small></div><div style=display:none><div class=small-print><small><wb:follow-button uid=2446212465 type=red_1 width=67 height=24></wb:follow-button></small></div></div></div></div><div id=main><div class=header><h1>Sonar实践问题记录(七)node版本排查</h1><h2></h2></div><div class=content><div class=post-meta><div><i class="fa fa-calendar fa-fw"></i>
<time>2020-03-07</time></div><div><i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=http://gebitang.com/topics/jiansh>jiansh</a>&nbsp;/
<a class=post-taxonomy-topic href=http://gebitang.com/topics/us>US</a></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=http://gebitang.com/tags/jiansh>jiansh</a></div></div><nav id=TableOfContents></nav><p><a href=https://www.jianshu.com/p/b63ca466b644>link on JianShu</a></p><p><a href=https://stackoverflow.com/a/33510581/1087122>关键问题 #!/usr/bin/env node</a></p><p>采用事实上标准而不是通用标准。所以前端项目扫描使用ESlint，而不是Sonar自带的扫描规则。（如何使用的逻辑还没有搞清楚，使用的环境已是ready状态）。</p><p>前端同事已经封装了eslint接口，只需要提供扫描的项目目录和输出地址，就可以完成扫描动作。这对我的接入就非常方便了。</p><p>问题是：“版本太低，语法不支持。”</p><pre tabindex=0><code>        ...calculateStatsPerFile(messages)
        ^^^

SyntaxError: Unexpected token ...
    at createScript (vm.js:56:10)
    at Object.runInThisContext (vm.js:97:10)
    at Module._compile (module.js:549:28)
    at Object.Module._extensions..js (module.js:586:10)
    at Module.load (module.js:494:32)
    at tryModuleLoad (module.js:453:12)
    at Function.Module._load (module.js:445:3)
    at Module.require (module.js:504:17)
    at require (internal/module.js:20:19)
    at Object.&lt;anonymous&gt; (/root/.nvm/versions/node/v10.13.0/lib/node_modules/eslint-my-server/node_modules/eslint/lib/cli-engine/index.js:3:23)
</code></pre><p>登录到服务器检查，<code>node -v</code>显示版本为<code>v10.13.0</code>已经足够新。前端建议在调用写的js脚本前指定node目录，类似<code>/root/.nvm/versions/node/v10.13.0/bin/node</code></p><p>先手动验证，<del>这样是无效的</del>。这样是有效的，但在系统执行时不知是否依然有效。因为手动验证时，即使不手动指定node，依然可以正常执行。</p><p>类似下面这两个执行方式都可以获得到结果——</p><pre tabindex=0><code># with node prefix
/root/.nvm/versions/node/v10.13.0/bin/node /root/.nvm/versions/node/v10.13.0/bin/eslint-my-server -p project-path -o result.json
# without node prefix
/root/.nvm/versions/node/v10.13.0/bin/eslint-my-server -p project-path -o result.json
</code></pre><p>检查一下环境，已经js脚本实际的内容——</p><pre tabindex=0><code>nod[root@testme]# node -v
v10.13.0
[root@testme]# which node
/root/.nvm/versions/node/v10.13.0/bin/node
[root@testme]# whereis node
node: /usr/bin/node /usr/share/node /root/.nvm/versions/node/v10.13.0/bin/node
[root@testme]# ll /root/.nvm/versions/node/v10.13.0/bin/eslint-cars-server 
lrwxrwxrwx. 1 root root 51 Dec 13 17:17 /root/.nvm/versions/node/v10.13.0/bin/eslint-my-server -&gt; ../lib/node_modules/eslint-my-server/bin/index.js
[root@testme]# cat /root/.nvm/versions/node/v10.13.0/lib/node_modules/eslint-my-server/bin/index.js 
#!/usr/bin/env node
</code></pre><p>js脚本指定了 <code>#!/usr/bin/env node</code>，默认会检查<code>/usr/bin/</code>目录下的node？</p><p>root启动的java应用中的环境与 terminal登录进去的环境似乎有差异？</p><p>写一个简单的java程序检查一下几个node（保存为nodecheck.java文件）</p><pre tabindex=0><code>import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;

class NodeCheck {

    public static void main(String[] args) {
        check(&#34;node -v&#34;);
        check(&#34;/usr/bin/node -v&#34;);
        check(&#34;/root/.nvm/versions/node/v10.13.0/bin/node -v&#34;);
    }

    private static void check(String command)  {


        StringBuilder sb = new StringBuilder();
        String line;
        try  {
            Process exec = Runtime.getRuntime().exec(command, null, null);
            BufferedReader br = new BufferedReader(new InputStreamReader(exec.getInputStream()));
            while ((line = br.readLine()) != null) {
                sb.append(line).append(&#34;\n&#34;);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
        System.out.println(command + &#34; --&gt; &#34;+ sb.toString());

    }
}
</code></pre><p><code>javac NodeCheck.java</code>然后<code>java NodeCheck</code>可以看到输出——</p><pre tabindex=0><code>[root@testme]# javac nodecheck.java 
[root@testme]# java NodeCheck 
node -v --&gt; v10.13.0

/usr/bin/node -v --&gt; v6.17.1

/root/.nvm/versions/node/v10.13.0/bin/node -v --&gt; v10.13.0
</code></pre><p>这样可以确定，Java应用中使用了<code>v6.17.1</code>版本的node，所以会提示<code>Unexpected token ...</code></p><p>简单暴力解决，动态判断两个node版本，不一致时直接使用新版本覆盖<code>/usr/bin</code>目录下的node。</p><div class="prev-next-post pure-g"><div class=pure-u-1-24 style=text-align:left><a href=http://gebitang.com/post/jiansh/us/sonar%E5%AE%9E%E8%B7%B5%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95%E4%B8%89-sonarqube/><i class="fa fa-chevron-left"></i></a></div><div class=pure-u-10-24><nav class=prev><a href=http://gebitang.com/post/jiansh/us/sonar%E5%AE%9E%E8%B7%B5%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95%E4%B8%89-sonarqube/>Sonar实践问题记录(三)-SonarQube</a></nav></div><div class=pure-u-2-24>&nbsp;</div><div class=pure-u-10-24><nav class=next><a href=http://gebitang.com/post/jiansh/us/sonar%E5%AE%9E%E8%B7%B5%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95%E4%B8%80/>Sonar实践问题记录(一)</a></nav></div><div class=pure-u-1-24 style=text-align:right><a href=http://gebitang.com/post/jiansh/us/sonar%E5%AE%9E%E8%B7%B5%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95%E4%B8%80/><i class="fa fa-chevron-right"></i></a></div></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="gebitang",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><script src=http://gebitang.com/js/ui.js></script>
<script src=http://gebitang.com/js/menus.js></script>
<script>window.location.hostname!="localhost"&&(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-34303694-1","auto"),ga("send","pageview"))</script><button onclick=topFunction() id=myBtn title="Go to top">Top</button></body></html>