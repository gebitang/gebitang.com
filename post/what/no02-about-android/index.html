<!doctype html><html xmlns:wb=http://open.weibo.com/wb lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="try to develop an andorid app"><meta name=generator content="Hugo 0.114.0"><title>About Android &#183; 戈壁堂</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=http://gebitang.com/css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=http://gebitang.com/css/side-menu.css><!--<![endif]--><link rel=stylesheet href=http://gebitang.com/css/blackburn.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.9.0/css/all.css><link href="https://fonts.googleapis.com/css?family=Raleway" rel=stylesheet type=text/css><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js></script>
<script>hljs.initHighlightingOnLoad()</script><link rel="shortcut icon" href=http://gebitang.com/img/favicon.ico type=image/x-icon><link rel=stylesheet href=http://gebitang.com/css/my.css><script src=http://gebitang.com/js/my.js></script></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><a class="pure-menu-heading brand" href=http://gebitang.com/>Gebitang</a><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/post/><i class='fa fa-list fa-fw'></i>Posts</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/about/><i class='fa fa-user fa-fw'></i>About</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/contact/><i class='fa fa-phone fa-fw'></i>Contact</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=http://gebitang.com/topics/><i class='fa fa-folder fa-fw'></i>Topics</a></li></ul></div><div class="pure-menu social"><ul class=pure-menu-list></ul></div><div><div class=small-print><small><a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt=知识共享许可协议 style=border-width:0 src=https://i.creativecommons.org/l/by/4.0/80x15.png></a><br>本<span xmlns:dct=http://purl.org/dc/terms/ href=http://purl.org/dc/dcmitype/Text rel=dct:type>作品</span>由<a xmlns:cc=http://creativecommons.org/ns# href=http://gebitang.com property="cc:attributionName" rel=cc:attributionurl>&nbsp;Gebitang&nbsp;&nbsp;</a>采用<a rel=license href=http://creativecommons.org/licenses/by/4.0/>知识共享署名 4.0 国际许可协议</a>进行许可&nbsp;&copy; 2018</small></div><div class=small-print><small></small></div><div class=small-print><small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small></div><div style=display:none><div class=small-print><small><wb:follow-button uid=2446212465 type=red_1 width=67 height=24></wb:follow-button></small></div></div></div></div><div id=main><div class=header><h1>About Android</h1><h2>try to develop an andorid app</h2></div><div class=content><div class=post-meta><div><i class="fa fa-calendar fa-fw"></i>
<time>2018-01-02</time></div><div><i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=http://gebitang.com/topics/android>android</a></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=http://gebitang.com/tags/android>android</a></div></div><nav id=TableOfContents><ul><li><a href=#android-monkey>Android Monkey</a></li><li><a href=#android-problem>Android problem</a><ul><li><a href=#android-studio>Android Studio</a><ul><li><a href=#setup-on-mac-m1>setup on Mac M1</a></li><li><a href=#无法启动>无法启动</a></li></ul></li><li><a href=#重新打包minicat>重新打包minicat</a></li><li><a href=#android项目打包>android项目打包</a></li><li><a href=#download-old-adt-eclipse-for-android>download old adt (Eclipse for android)</a></li><li><a href=#decompile-android-apk>decompile android apk</a></li><li><a href=#adb-forward>adb forward</a></li><li><a href=#android-studio-as-desktop-entry>android-studio as desktop entry</a></li><li><a href=#graphics-buffer>Graphics Buffer</a></li><li><a href=#logcat--v-time-i-顺序>logcat -v time &ldquo;*:I&rdquo; 顺序</a></li><li><a href=#adb-no-permissions>adb no permissions</a></li><li><a href=#app_process-command>app_process command</a></li><li><a href=#secure-window>Secure Window</a></li><li><a href=#监听home键>监听home键</a></li><li><a href=#adding-jar-files-to-your-testing-classpath>Adding JAR files to your testing classpath</a></li><li><a href=#download-old-ndk>download old ndk</a></li><li><a href=#download-built-tools-directly>download built-tools directly</a></li><li><a href=#update-ui-from-background-service>update UI from background service</a></li><li><a href=#adb-reverse>adb reverse</a></li><li><a href=#debug-on-device>debug on device</a></li><li><a href=#waiting-for-debugger>Waiting For Debugger</a></li><li><a href=#delete_failed_device_policy_manager>DELETE_FAILED_DEVICE_POLICY_MANAGER</a></li></ul></li><li><a href=#android-adb>Android ADB</a><ul><li><a href=#how-does-adb-shell-getprop-and-setprop-work>how does adb shell getprop and setprop work</a></li><li><a href=#adb-overview-and-services>adb overview and services</a></li><li><a href=#adb-devices>adb devices</a></li></ul></li><li><a href=#gradle-dependencies>gradle dependencies</a></li><li><a href=#proguard>proguard</a></li><li><a href=#build-apk-without-test-app>build apk without test app</a></li><li><a href=#unable-to-add-window-permission-denied-for-this-window-type>Unable to add window. Permission denied for this window type</a></li><li><a href=#unable-to-instantiate-service>Unable to instantiate service</a></li><li><a href=#android-studio-1>Android Studio</a><ul><li><a href=#cannot-resolve-symbol-r-in-android-studio>“cannot resolve symbol R” in Android Studio</a></li><li><a href=#cannot-resolve-symbol-xxx>Cannot resolve symbol &lsquo;xxx&rsquo;</a></li></ul></li><li><a href=#insufficient-permissions-for-device>insufficient permissions for device</a></li><li><a href=#about-icon>about icon</a></li><li><a href=#android-apk>Android APK</a><ul><li><a href=#点击icon到启动应用>点击icon到启动应用</a></li><li><a href=#生成签名文件>生成签名文件</a></li><li><a href=#dumpsys-command>dumpsys command</a></li><li><a href=#签名打包release版本>签名、打包release版本</a></li><li><a href=#静态变量失效数据保存>静态变量失效，数据保存</a></li><li><a href=#读取短信信息动态请求权限>读取短信信息，动态请求权限</a></li></ul></li><li><a href=#android-surface-system>Android Surface System</a><ul><li><a href=#screenshotclient的update方法>ScreenshotClient的update方法：</a></li><li><a href=#minicap方法的逻辑>Minicap方法的逻辑：</a></li><li><a href=#aidl工具>aidl工具：</a></li><li><a href=#configuration-with-name-debugandroidtestcompile-not-found>Configuration with name &lsquo;debugAndroidTestCompile&rsquo; not found.</a></li></ul></li></ul></nav><h2 id=android-monkey>Android Monkey</h2><p><code>getSystemInterfaces()</code>方法依赖底层未开放的系统服务获取到三个对象——</p><ul><li><p><code>ActivityManager</code>：通过调用setActivityController()对整个测试周期进行控制</p></li><li><p><code>IWindowManager</code>：通过IWindowManager提供的方法是的monkey将点击、按键、翻转等事件加入应用中</p></li><li><p><code>IPackageManager</code>：通过IPackageManager获取应用列表，以便在测试时可在多个应用中随机切换</p></li><li><p><a href=https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/app/ActivityManager.java>ActivityManager</a></p></li><li><p><a href=https://github.com/aosp-mirror/platform_frameworks_base>android base soucre</a></p></li><li><p><a href=https://github.com/aosp-mirror/platform_development>android platform source</a></p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>* @hide
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@UnsupportedAppUsage</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> IActivityManager <span style=color:#a6e22e>getService</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> IActivityManagerSingleton<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> IActivityTaskManager <span style=color:#a6e22e>getTaskService</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ActivityTaskManager<span style=color:#f92672>.</span><span style=color:#a6e22e>getService</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@UnsupportedAppUsage</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Singleton<span style=color:#f92672>&lt;</span>IActivityManager<span style=color:#f92672>&gt;</span> IActivityManagerSingleton <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> Singleton<span style=color:#f92672>&lt;</span>IActivityManager<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>protected</span> IActivityManager <span style=color:#a6e22e>create</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> IBinder b <span style=color:#f92672>=</span> ServiceManager<span style=color:#f92672>.</span><span style=color:#a6e22e>getService</span><span style=color:#f92672>(</span>Context<span style=color:#f92672>.</span><span style=color:#a6e22e>ACTIVITY_SERVICE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> IActivityManager am <span style=color:#f92672>=</span> IActivityManager<span style=color:#f92672>.</span><span style=color:#a6e22e>Stub</span><span style=color:#f92672>.</span><span style=color:#a6e22e>asInterface</span><span style=color:#f92672>(</span>b<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> am<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>};</span>
</span></span></code></pre></div><h2 id=android-problem>Android problem</h2><h3 id=android-studio>Android Studio</h3><h4 id=setup-on-mac-m1>setup on Mac M1</h4><pre tabindex=0><code>Preparing &#34;Install Android SDK Build-Tools 33 (revision: 33.0.0)&#34;.
Downloading https://dl.google.com/android/repository/build-tools_r33-macosx.zip
&#34;Install Android SDK Build-Tools 33 (revision: 33.0.0)&#34; ready.
Installing Android SDK Build-Tools 33 in /Users/geb/Library/Android/sdk/build-tools/33.0.0
&#34;Install Android SDK Build-Tools 33 (revision: 33.0.0)&#34; complete.
&#34;Install Android SDK Build-Tools 33 (revision: 33.0.0)&#34; finished.
Preparing &#34;Install Sources for Android 33 (revision: 1)&#34;.
Downloading https://dl.google.com/android/repository/sources-33_r01.zip
&#34;Install Sources for Android 33 (revision: 1)&#34; ready.
Installing Sources for Android 33 in /Users/geb/Library/Android/sdk/sources/android-33
&#34;Install Sources for Android 33 (revision: 1)&#34; complete.
&#34;Install Sources for Android 33 (revision: 1)&#34; finished.
Preparing &#34;Install Android SDK Platform 33 (revision: 2)&#34;.
Downloading https://dl.google.com/android/repository/platform-33_r02.zip
&#34;Install Android SDK Platform 33 (revision: 2)&#34; ready.
Installing Android SDK Platform 33 in /Users/geb/Library/Android/sdk/platforms/android-33
&#34;Install Android SDK Platform 33 (revision: 2)&#34; complete.
&#34;Install Android SDK Platform 33 (revision: 2)&#34; finished.
Preparing &#34;Install Android Emulator (revision: 31.3.10)&#34;.
Downloading https://dl.google.com/android/repository/emulator-darwin_aarch64-8807927.zip
&#34;Install Android Emulator (revision: 31.3.10)&#34; ready.
Installing Android Emulator in /Users/geb/Library/Android/sdk/emulator
&#34;Install Android Emulator (revision: 31.3.10)&#34; complete.
&#34;Install Android Emulator (revision: 31.3.10)&#34; finished.
Preparing &#34;Install SDK Patch Applier v4 (revision: 1)&#34;.
Downloading https://dl.google.com/android/repository/3534162-studio.sdk-patcher.zip
&#34;Install SDK Patch Applier v4 (revision: 1)&#34; ready.
Installing SDK Patch Applier v4 in /Users/geb/Library/Android/sdk/patcher/v4
&#34;Install SDK Patch Applier v4 (revision: 1)&#34; complete.
&#34;Install SDK Patch Applier v4 (revision: 1)&#34; finished.
Preparing &#34;Install Google APIs ARM 64 v8a System Image (revision: 6)&#34;.
Downloading https://dl.google.com/android/repository/sys-img/google_apis/arm64-v8a-33_r06.zip
&#34;Install Google APIs ARM 64 v8a System Image (revision: 6)&#34; ready.
Installing Google APIs ARM 64 v8a System Image in /Users/geb/Library/Android/sdk/system-images/android-33/google_apis/arm64-v8a
&#34;Install Google APIs ARM 64 v8a System Image (revision: 6)&#34; complete.
&#34;Install Google APIs ARM 64 v8a System Image (revision: 6)&#34; finished.
Preparing &#34;Install Android SDK Platform-Tools (revision: 33.0.3)&#34;.
Downloading https://dl.google.com/android/repository/platform-tools_r33.0.3-darwin.zip
&#34;Install Android SDK Platform-Tools (revision: 33.0.3)&#34; ready.
Installing Android SDK Platform-Tools in /Users/geb/Library/Android/sdk/platform-tools
&#34;Install Android SDK Platform-Tools (revision: 33.0.3)&#34; complete.
&#34;Install Android SDK Platform-Tools (revision: 33.0.3)&#34; finished.
Parsing /Users/geb/Library/Android/sdk/build-tools/33.0.0/package.xml
Parsing /Users/geb/Library/Android/sdk/emulator/package.xml
Parsing /Users/geb/Library/Android/sdk/patcher/v4/package.xml
Parsing /Users/geb/Library/Android/sdk/platform-tools/package.xml
Parsing /Users/geb/Library/Android/sdk/platforms/android-33/package.xml
Parsing /Users/geb/Library/Android/sdk/sources/android-33/package.xml
Parsing /Users/geb/Library/Android/sdk/system-images/android-33/google_apis/arm64-v8a/package.xml
Android SDK is up to date.
Creating Android virtual device
Android virtual device Pixel_3a_API_33_arm64-v8a was successfully created
</code></pre><p><a href=https://www.cmd-ltd.com/advice-centre/usb-chargers-and-power-modules/usb-and-power-module-product-help/usb-data-transfer-guide/>https://www.cmd-ltd.com/advice-centre/usb-chargers-and-power-modules/usb-and-power-module-product-help/usb-data-transfer-guide/</a></p><h4 id=无法启动>无法启动</h4><p>升级之后，第一次无法启动页面，在任务管理器中显示已经启动。</p><p>在bin目录的<code>idea.properties</code>文件中添加一行<code>disable.android.first.run=true</code>避免首次启动时自动重新下载SDK（在 Android SDK Manager 中是可以更新SDK）</p><h3 id=重新打包minicat>重新打包minicat</h3><p>一个古老的项目，用来同步FF和WB挺好用。看起来一年打包一次？命令行执行<code>gradlew bundle</code>最终限制在<code>Could not resolve com.android.support:support-v4:27.1.1</code>。重新升级AS到4.1版本，智能提醒最后还是提示相同的错误。</p><p><a href=https://stackoverflow.com/questions/49856331/failed-to-resolve-com-android-supportsupport-v427-1-1>Failed to resolve: com.android.support:support-v4:27.1.1</a>类似问题提示，在<code>build.gradle</code>文件中添加——</p><pre tabindex=0><code>allprojects {
    repositories {
        google()
        jcenter()
    }
}
</code></pre><p>然后AS提示需要升级NDK到<a href=https://dl.google.com/android/repository/android-ndk-r21-windows-x86_64.zip><code>NDK (Side by side) 21.0.6113669 (ndk;21.0.6113669)</code></a>，大小1GB左右</p><p><a href=https://developer.android.com/studio/releases/gradle-plugin>Android Gradle plugin 和gradle版本的对应关系</a></p><p>折腾半天，还是恢复原状是work状态- -|| 升级操作后，<code>java.lang.NullPointerException: Attempt to invoke virtual method 'void android.support.v4.widget.SwipeRefreshLayout.setColorSchemeResources(int[])' on a null object reference</code> 因为对于的support版本支持的有问题。</p><ul><li>下载使用本地wrapper包</li><li>更新key内容<a href=https://open.weibo.com/tools/console>weibo console</a></li><li>命令行打包debug版本就够用<a href=https://developer.android.com/studio/build/building-cmdline#DebugMode>Build a debug APK</a>执行<code>./gradlew assembleDebug</code>完成编译，产生的文件在<code>module_name-debug.apk</code>在<code>project_name/module_name/build/outputs/apk/</code>目录下（在Andoid Studio仅查看代码）</li></ul><p>ps: Mac环境下又重新折腾了一次。23.0.3版本的build-tools在Mac版本下工作不正常，提示错误<code>bad CPU type in executable</code>。重新下载一个高版本<a href=https://androidsdkmanager.azurewebsites.net/Buildtools>24.0</a>的即可。解压后将<code>aapt</code>和<code>zipalign</code>可执行文件复制到指定的目录下即可</p><p><a href="https://developer.android.com/about/versions/11/privacy/storage?hl=zh-cn">Android 11 中的存储机制更新</a>从 Android 11 开始，应用无法在外部存储设备上创建自己的应用专用目录。如需访问系统为您的应用提供的目录，请调用 getExternalFilesDirs()。</p><h3 id=android项目打包>android项目打包</h3><p>提示报错：</p><blockquote><p>error default interface methods are only supported starting with android n (&ndash;min-api 24)</p></blockquote><p><a href=https://stackoverflow.com/questions/49512629/default-interface-methods-are-only-supported-starting-with-android-n>解决方法</a></p><pre tabindex=0><code>android {
...
  compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
...
}
</code></pre><p>android项目打包——</p><ul><li>安装包——选择app运行，安装到手机，即可获取到apk</li><li>测试包——运行测试代码，即可获取到测试apk</li></ul><p><a href=https://developer.android.com/guide/topics/manifest/receiver-element>manifest</a></p><h3 id=download-old-adt-eclipse-for-android>download old adt (Eclipse for android)</h3><p><a href=https://stackoverflow.com/questions/27418096/where-can-i-download-eclipse-android-bundle>SOF</a></p><p>Here you can download adt bundles 2014-07-02:</p><p>windows 32 bit: <a href=https://dl.google.com/android/adt/adt-bundle-windows-x86-20140702.zip>https://dl.google.com/android/adt/adt-bundle-windows-x86-20140702.zip</a></p><p>windows 64 bit: <a href=https://dl.google.com/android/adt/adt-bundle-windows-x86_64-20140702.zip>https://dl.google.com/android/adt/adt-bundle-windows-x86_64-20140702.zip</a></p><p>MacOS 64 bit: <a href=https://dl.google.com/android/adt/adt-bundle-mac-x86_64-20140702.zip>https://dl.google.com/android/adt/adt-bundle-mac-x86_64-20140702.zip</a></p><p>Linux 32 bit: <a href=https://dl.google.com/android/adt/adt-bundle-linux-x86-20140702.zip>https://dl.google.com/android/adt/adt-bundle-linux-x86-20140702.zip</a></p><p>Linux 64 bit: <a href=https://dl.google.com/android/adt/adt-bundle-linux-x86_64-20140702.zip>https://dl.google.com/android/adt/adt-bundle-linux-x86_64-20140702.zip</a></p><h3 id=decompile-android-apk>decompile android apk</h3><p><a href=https://stackoverflow.com/questions/21010367/how-to-decompile-an-apk-or-dex-file-on-android-platform>How to decompile an APK or DEX file on Android platform</a></p><ul><li>unzip apk file to get dex file.</li><li>d2j-dex2jar.bat classes.dex to get</li><li>use java decompiler to open jar file.</li></ul><p><a href=https://medium.com/@felipegi91_89910/decompile-android-apk-62507a04798d>Decompile Android .apk</a></p><p>use <code>apktool d android.apk</code> to unzip file.</p><h3 id=adb-forward>adb forward</h3><p>adb forward tcp:6100 localabstract:minicap //PC上所有6100端口通信数据将被重定向到手机端minicap的server上
adb forward tcp:6100 tcp:7100 // PC上所有6100端口通信数据将被重定向到手机端7100端口server上
adb forward tcp:6100 local:logd // PC上所有6100端口通信数据将被重定向到手机端UNIX类型socket上</p><h3 id=android-studio-as-desktop-entry>android-studio as desktop entry</h3><p><a href=https://askubuntu.com/questions/298857/how-to-add-android-studio-to-the-launcher>How to add Android Studio to the launcher?</a></p><p>Configure -> Create Desktop Entry</p><p>or</p><pre tabindex=0><code>[Desktop Entry]
Version=1.0
Type=Application
Name=Android Studio
Exec=&#34;/home/username/Programs/AndroidStudio/bin/studio.sh&#34; %f
Icon=/home/username/Programs/AndroidStudio/bin/idea.png
Categories=Development;IDE;
Terminal=false
StartupNotify=true
StartupWMClass=jetbrains-android-studio
Name[en_GB]=android-studio.desktop
</code></pre><h3 id=graphics-buffer>Graphics Buffer</h3><p><a href=https://www.codeproject.com/Articles/990983/Androids-Graphics-Buffer-Management-System-Part-II>Android&rsquo;s Graphics Buffer Management System (Part II: BufferQueue)</a></p><h3 id=logcat--v-time-i-顺序>logcat -v time &ldquo;*:I&rdquo; 顺序</h3><p>此顺序可在各个版本上使用，获取到包含时间戳的log信息。</p><p>使用 logcat &ldquo;*:I&rdquo; -v time 在低于5.0版本的设备上无法获取到时间戳。</p><h3 id=adb-no-permissions>adb no permissions</h3><p><a href=https://stackoverflow.com/questions/14460656/android-debug-bridge-adb-device-no-permissions>Android Debug Bridge (adb) device - no permissions</a></p><pre tabindex=0><code>sudo ./adb kill-server
sudo ./adb start-server
adb devices

# or adn new rule https://stackoverflow.com/a/19291975/1087122
lsusb
Bus 002 Device 002: ID 8087:8000 Intel Corp. 
Bus 002 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 001 Device 002: ID 8087:8008 Intel Corp. 
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 003 Device 009: ID 18d1:4ee7 Google Inc. 

# Create a file /etc/udev/rules.d/99-adb.rules containing the following line:
ATTRS{idVendor}==&#34;18d1&#34;, ATTRS{idProduct}==&#34;4ee7&#34;, ENV{ID_GPHOTO2}=&#34;1&#34;, ENV{GPHOTO2_DRIVER}=&#34;proprietary&#34;, ENV{ID_MEDIA_PLAYER}=&#34;1&#34;, MODE=&#34;0666&#34;, GROUP=&#34;plugdev&#34;

#Restart udev
$ sudo udevadm control --reload-rules
$ sudo service udev restart
</code></pre><p>or just change connection mode from charge to PPP(Picture Transfer Protocol). <a href=https://stackoverflow.com/a/49216677/1087122>check here</a></p><h3 id=app_process-command>app_process command</h3><p><a href="http://blog.djodjo.org/?p=414">app_process command in Android</a></p><p><code>am start -n yourpackagename/.activityname</code> “am” is just a shell script and what stays in the base of the am script is our app_process binary:</p><pre tabindex=0><code>root@android:/ # cat /system/bin/am
cat /system/bin/am
# Script to start &#34;am&#34; on the device, which has a very rudimentary
# shell.
#
base=/system
export CLASSPATH=$base/framework/am.jar
exec app_process $base/bin com.android.commands.am.Am &#34;$@&#34;
root@android:/ #
</code></pre><h3 id=secure-window>Secure Window</h3><pre tabindex=0><code>//to forbid screen shot.  W/SurfaceFlinger: FB is protected: PERMISSION_DENIED
getWindow().setFlags(WindowManager.LayoutParams.FLAG_SECURE, WindowManager.LayoutParams.FLAG_SECURE);
</code></pre><h3 id=监听home键>监听home键</h3><p>注册广播，监听home键
<a href=http://www.cnblogs.com/mengdd/p/3951223.html>Android Back Home键监听</a>
<a href=https://stackoverflow.com/questions/8881951/detect-home-button-press-in-android>Detect home button press in android</a></p><h3 id=adding-jar-files-to-your-testing-classpath>Adding JAR files to your testing classpath</h3><p><a href=https://stackoverflow.com/a/32566894/1087122>Adding JAR files to your testing classpath</a>
package jar files under testlibs folder.</p><pre tabindex=0><code>dependencies {
    ...
    testCompile fileTree(dir: &#39;testlibs&#39;, include: [&#39;*.jar&#39;])
}
</code></pre><h3 id=download-old-ndk>download old ndk</h3><p><a href=https://developer.android.com/ndk/downloads/older_releases>ndk old release</a></p><h3 id=download-built-tools-directly>download built-tools directly</h3><p><a href=https://stackoverflow.com/questions/26016770/how-to-install-old-version-of-android-build-tools-from-command-line>to install old version of Android build tools from command line</a></p><p>manually open the XML file that is shown when during <code>android sdk list</code> <a href=https://dl.google.com/android/repository/repository-11.xml>xml detail</a></p><pre tabindex=0><code>&lt;sdk:archive&gt;
 &lt;!-- Built on: Mon Jun  4 07:14:07 2018. --&gt;
&lt;sdk:size&gt;20828006&lt;/sdk:size&gt;
&lt;sdk:checksum type=&#34;sha1&#34;&gt;cf20720e452b642d5eb59dabe05c0c729b36ec75&lt;/sdk:checksum&gt;
&lt;sdk:url&gt;build-tools_r20-windows.zip&lt;/sdk:url&gt;
&lt;sdk:host-os&gt;windows&lt;/sdk:host-os&gt;
&lt;/sdk:archive&gt;
</code></pre><h3 id=update-ui-from-background-service>update UI from background service</h3><p><a href=https://medium.com/@anitaa_1990/how-to-update-an-activity-from-background-service-or-a-broadcastreceiver-6dabdb5cef74>update UI from background service</a></p><p>3 basic implementations:</p><ul><li>Using LocalBroadcastReceivers</li><li>Using ResultReceiver</li><li>Using Handlers</li></ul><p><a href=https://stackoverflow.com/questions/14643385/how-to-update-ui-in-a-broadcastreceiver>How to update UI in a BroadcastReceiver</a></p><p><a href=https://stackoverflow.com/questions/5674518/does-broadcastreceiver-onreceive-always-run-in-the-ui-thread>Does BroadcastReceiver.onReceive always run in the UI thread?</a></p><p><a href=https://developer.android.com/reference/android/content/BroadcastReceiver#onReceive(android.content.Context,%20android.content.Intent)>BroadcastReceiver#onReceive</a></p><p><a href=http://www.vogella.com/tutorials/AndroidListView/article.html>Using lists in Android wth ListView - Tutorial</a></p><h3 id=adb-reverse>adb reverse</h3><p><a href=https://handstandsam.com/2016/02/01/network-calls-from-android-device-to-laptop-over-usb-via-adb/>Network Calls from Android Device to Laptop over USB via ADB</a>
Android’s “adb reverse” command is available in Lollipop and higher versions of Android (Platform 21+)</p><p><a href=https://github.com/facebook/react-native/issues/2885>cannot run app on Android 4.4 device</a>
The documentation provided is for Android 5.0 and above as adb reverse works only from Android 5.0 and above.</p><h3 id=debug-on-device>debug on device</h3><p><a href=https://developer.android.com/studio/debug/>debug on device</a></p><p>You must use a <code>build variant</code> that includes <code>debuggable true</code> in the build configuration.</p><pre tabindex=0><code>android {
    buildTypes {
        customDebugType {
            debuggable true
            ...
        }
    }
}
</code></pre><h3 id=waiting-for-debugger>Waiting For Debugger</h3><p><a href=https://stackoverflow.com/questions/27436050/debugging-with-android-studio-stuck-at-waiting-for-debugger-forever>Android Studio stuck at “Waiting For Debugger” forever</a></p><blockquote><p>menu -> Run -> Attach debugger to Android process</p></blockquote><h3 id=delete_failed_device_policy_manager>DELETE_FAILED_DEVICE_POLICY_MANAGER</h3><p><a href=https://blog.csdn.net/the01hierarch/article/details/7313071>应用程序不能卸载</a>是因为在手机的<code>安全-->设备管理器</code>中进行了激活，只有取消激活后才能删除。</p><p><a href=https://blog.csdn.net/kitty_landon/article/details/47300907>卸载程序</a>要调<code>IDevicePolicyManager</code>服务里（在<code>DevicePolicyManagerService.java</code>里实现）的<code>packageHasActiveAdmins()</code>函数检查是否具备admin权限，如果没有admin权限，则直接返回不卸载程序，有了admin才去卸载程序。</p><p>dump应用的权限信息通常可以看到 <code>provides-component:'device-admin'</code></p><h2 id=android-adb>Android ADB</h2><p><a href=https://developer.android.com/studio/command-line/adb>commond line adb</a>
<a href=https://developer.android.google.cn/studio/command-line/adb>doc for cn</a></p><h3 id=how-does-adb-shell-getprop-and-setprop-work>how does adb shell getprop and setprop work</h3><p><a href=https://stackoverflow.com/a/40624561/1087122>Android system properties are being managed</a> by special property_service. The <code>/system/build.prop</code> is just one out of 4-6 (depending on the version) read-only files containing the default values that <code>property_service</code> uses to populate its internal in-memory database with during start-up. So changes to the files during run time would not propagate until after reboot.</p><p>The setprop and getprop commands are used to access the data in that database. Unless the property name starts with persist. - then the value gets stored in <code>/data/property</code> folder.</p><h3 id=adb-overview-and-services>adb overview and services</h3><p><a href=https://stackoverflow.com/a/21338505/1087122>question</a></p><p><strong>A client</strong>, which sends commands. The client runs on your development machine. You can invoke a client from a command-line terminal by issuing an adb command.
<strong>A daemon (adbd)</strong>, which runs commands on a device. The daemon runs as a background process on each device.
<strong>A server</strong>, which manages communication between the client and the daemon. The server runs as a background process on your development machine.</p><p>The source code for all 3 parts of ADB is in the same <a href=https://android.googlesource.com/platform/system/core/+/master/adb>system/core/adb</a> folder.
<a href=https://android.googlesource.com/platform/system/core/+/master/adb/OVERVIEW.TXT>overview</a>
<a href=https://android.googlesource.com/platform/system/core/+/master/adb/SERVICES.TXT>services</a></p><h3 id=adb-devices>adb devices</h3><p><a href=https://stackoverflow.com/a/21338505/1087122>Where is the ADB server code that handles the “devices” command?</a></p><p><a href=https://github.com/aosp-mirror/platform_system_core/tree/master/adb>source code for this question</a></p><p><a href=https://github.com/aosp-mirror/platform_system_core/blob/9f5e6dbe854ca41d337a1fa8fc8efe95e22db04b/adb/adb.cpp#L1094>it&rsquo;s in adb.cpp</a></p><h2 id=gradle-dependencies>gradle dependencies</h2><p><a href=https://developer.android.google.cn/studio/build/dependencies>dependencies types</a></p><pre tabindex=0><code>// Dependency on a local library module
implementation project(&#34;:mylibrary&#34;)

// Dependency on local binaries
implementation fileTree(dir: &#39;libs&#39;, include: [&#39;*.jar&#39;])

// Dependency on a remote binary
implementation &#39;com.example.android:app-magic:12.3&#39;
</code></pre><p>dependency configurations</p><pre tabindex=0><code>implementation
api
compileOnly
runtimeOnly
annotationProcessor
</code></pre><h2 id=proguard>proguard</h2><p>proguard not work for test app, <a href=https://github.com/googlesamples/android-testing-templates/issues/27>see this</a></p><h2 id=build-apk-without-test-app>build apk without test app</h2><p>you need to go to Build > Build APK(s) to have a non testable release apk that you can submit to the store.</p><h2 id=unable-to-add-window-permission-denied-for-this-window-type>Unable to add window. Permission denied for this window type</h2><p><a href=https://stackoverflow.com/a/35716156/1087122>Unable to add window. Permission denied for this window type</a></p><p>If the app targets API level 23 or higher, the app user must explicitly grant this permission to the app through a permission management screen.</p><pre tabindex=0><code>private static final int OVERLAY_PERMISSION_REQ_CODE = 100;
    private Context context;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);
        setSupportActionBar(toolbar);
        context = MainActivity.this;

        FloatingActionButton fab = (FloatingActionButton) findViewById(R.id.fab);
        fab.setOnClickListener(new View.OnClickListener() {
            @RequiresApi(api = Build.VERSION_CODES.M)
            @Override
            public void onClick(View view) {
                //add the service here
                //make the button gone

                if ((Build.VERSION.SDK_INT &gt;= 23)) {
                    if (!Settings.canDrawOverlays(context)) {
                        Intent intent = new Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
                                Uri.parse(&#34;package:&#34; + getPackageName()));
                        startActivityForResult(intent, OVERLAY_PERMISSION_REQ_CODE);
                    } else if (Settings.canDrawOverlays(context)) {
                        startService(new Intent(context, FloatingCircle.class));
                    }
                }
                else
                {
                    startService(new Intent(context, FloatingCircle.class));
                }

            }
        });

    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        if (requestCode == OVERLAY_PERMISSION_REQ_CODE) {
            startService(new Intent(context, FloatingCircle.class));

        }
    }
</code></pre><h2 id=unable-to-instantiate-service>Unable to instantiate service</h2><p>You service needs to have a public no-args constructor. Otherwize, Android will not be able to instantiate it.
<a href=https://stackoverflow.com/questions/5027147/android-runtimeexception-unable-to-instantiate-the-service>Unable to instantiate service</a></p><p>需要一个无参的构造函数</p><h2 id=android-studio-1>Android Studio</h2><h3 id=cannot-resolve-symbol-r-in-android-studio>“cannot resolve symbol R” in Android Studio</h3><p><a href=https://stackoverflow.com/questions/17054000/cannot-resolve-symbol-r-in-android-studio>“cannot resolve symbol R” in Android Studio</a></p><ol><li>确保xml文件没有错误内容；</li><li>clean project and build and sync</li></ol><ul><li>Build -> Clean Project</li><li>File -> Sync Project with Gradle Files (tools bar with circle icon)</li></ul><h3 id=cannot-resolve-symbol-xxx>Cannot resolve symbol &lsquo;xxx&rsquo;</h3><p>AS特有的诡异问题。现象为：gradle build成功，但编辑器里总是提示Cannot resolve symbol &lsquo;xxx&rsquo;。</p><ol><li>invalidate cache and restart 不一定好使；</li><li>clean and rebuild project也无效</li><li>这时候，先需要将dependencies里对应的内容先注销（sync一次），再重新打开注释的dependencies内容，再sync一次</li></ol><h2 id=insufficient-permissions-for-device>insufficient permissions for device</h2><p>need to restart adb server. <code>adb kill-server ； adb start-server</code></p><p><a href=https://www.cnblogs.com/sipher/articles/2471205.html>adb shell 出现 insufficient permissions for device</a></p><h2 id=about-icon>about icon</h2><p><a href=https://blog.csdn.net/guolin_blog/article/details/50727753>Android drawable的细节</a></p><pre tabindex=0><code># icon size 
密度  建议尺寸
mipmap-mdpi 48 * 48
mipmap-hdpi 72 * 72
mipmap-xhdpi  96 * 96
mipmap-xxhdpi 144 * 144
mipmap-xxxhdpi  192 * 192

# about dpi
float xdpi = getResources().getDisplayMetrics().xdpi;
float ydpi = getResources().getDisplayMetrics().ydpi;

dpi范围 密度
0dpi ~ 120dpi ldpi
120dpi ~ 160dpi mdpi
160dpi ~ 240dpi hdpi
240dpi ~ 320dpi xhdpi
320dpi ~ 480dpi xxhdpi
480dpi ~ 640dpi xxxhdpi
</code></pre><h2 id=android-apk>Android APK</h2><h3 id=点击icon到启动应用>点击icon到启动应用</h3><p><a href=https://blog.csdn.net/qq_25047355/article/details/55260980>详解安卓从图表icon点击到APP启动界面加载流程</a></p><h3 id=生成签名文件>生成签名文件</h3><pre tabindex=0><code># need java JDK environment
# keytool --help
# keytool -genkey -help
 ~ keytool -genkey -alias gebitang -keyalg RSA -validity 20000 -keystore ./gebitang.keystore
Enter keystore password:
Re-enter new password:
What is your first and last name?
  [Unknown]:  JOECHINLI
What is the name of your organizational unit?
  [Unknown]:  gebitang
What is the name of your organization?
  [Unknown]:  geb
What is the name of your City or Locality?
  [Unknown]:  Beijing
What is the name of your State or Province?
  [Unknown]:  Beijing
What is the two-letter country code for this unit?
  [Unknown]:  cn
Is CN=JOECHINLEE, OU=gebitang, O=geb, L=Beijing, ST=Beijing, C=cn correct?
  [no]:
What is your first and last name?
  [JOECHINLEE]:
What is the name of your organizational unit?
  [gebitang]:
What is the name of your organization?
  [geb]:
What is the name of your City or Locality?
  [Beijing]:
What is the name of your State or Province?
  [Beijing]:
What is the two-letter country code for this unit?
  [cn]:
Is CN=JOECHINLEE, OU=gebitang, O=geb, L=Beijing, ST=Beijing, C=cn correct?
  [no]:  yes

Enter key password for &lt;gebitang.keystore&gt;
  (RETURN if same as keystore password):
</code></pre><h3 id=dumpsys-command>dumpsys command</h3><p><a href=http://gityuan.com/2016/05/14/dumpsys-command/>dumpsys command</a></p><pre tabindex=0><code># list?
adb shell dumpsys -l
Currently running services:
...
window


# list
adb shell service list

Found 111 services:
0 ims: [com.android.ims.internal.IImsService]
1 sip: [android.net.sip.ISipService]
2 com.qualcomm.location.izat.IzatService: [com.qualcomm.location.izat.IIzatService]
3 carrier_config: [com.android.internal.telephony.ICarrierConfigLoader]
...
110 android.security.keystore: [android.security.IKeystoreService]
</code></pre><h3 id=签名打包release版本>签名、打包release版本</h3><p><a href=https://www.cnblogs.com/details-666/p/keystore.html>Android Studio的两种模式及签名配置</a></p><ul><li>使用release版本 by Build Variants</li></ul><h3 id=静态变量失效数据保存>静态变量失效，数据保存</h3><p>实际使用中发现静态变量赋值后再次使用时依然是原始默认值。建议<a href=https://stackoverflow.com/a/10962472/1087122>使用Shared Preferences</a>或者统一定义 <a href=https://stackoverflow.com/a/8504129/1087122>Application</a>中。</p><h3 id=读取短信信息动态请求权限>读取短信信息，动态请求权限</h3><ul><li><a href=https://android.jlelse.eu/detecting-sending-sms-on-android-8a154562597f>动态请求读取短信权限</a> - pending</li></ul><p>设置<a href=https://developer.android.com/guide/topics/manifest/intent-filter-element.html>android:priority</a>，</p><pre tabindex=0><code># AndroidManifest.xml
&lt;receiver
    android:name=&#34;.SmsBroadcastReceiver&#34;
    android:enabled=&#34;true&#34;
    android:exported=&#34;true&#34;&gt;
    &lt;intent-filter android:priority=&#34;1000&#34;&gt;
        &lt;action android:name=&#34;android.provider.Telephony.SMS_RECEIVED&#34; /&gt;
    &lt;/intent-filter&gt;
&lt;/receiver&gt;

#发送短信
public class SmsBroadcastReceiver extends BroadcastReceiver {

    @Override
    public void onReceive(Context context, Intent intent) {
        sendSms(context, intent);
    }
}

# actual method
void sendSms(Context context, Intent intent) {
  if (Telephony.Sms.Intents.SMS_RECEIVED_ACTION.equals(intent.getAction())) {
      String smsSender = &#34;&#34;;
      StringBuilder sb = new StringBuilder();
      if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) {
          for (SmsMessage smsMessage : Telephony.Sms.Intents.getMessagesFromIntent(intent)) {
              smsSender = smsMessage.getDisplayOriginatingAddress();
              sb.append(smsMessage.getMessageBody());
          }
      } else {
          Bundle smsBundle = intent.getExtras();
          if (smsBundle != null) {
              Object[] pdus = (Object[]) smsBundle.get(&#34;pdus&#34;);
              if (pdus == null) {
                  // Display some error to the user
                  Log.e(Utils.tag, &#34;SmsBundle had no pdus key&#34;);
                  return;
              }
              SmsMessage[] messages = new SmsMessage[pdus.length];
              for (int i = 0; i &lt; messages.length; i++) {
                  messages[i] = SmsMessage.createFromPdu((byte[]) pdus[i]);
                  sb.append(messages[i].getMessageBody());
              }
              smsSender = messages[0].getOriginatingAddress();
          }
      }
      SharedPreferences settings = context.getSharedPreferences(Const.SAVE_DATE, 0);
      String phone = settings.getString(Const.phoneNum, SmsHelper.getPhoneNumber());
      String url = settings.getString(Const.smsUrl, SmsHelper.getReceiveSmsUrl());
      //Log.i(Utils.tag,  url+ &#34; now phone number: &#34; + phone);
      HttpClientUtil.uploadSmsInBackground(smsSender, sb.toString(), phone, url);
  }
</code></pre><h2 id=android-surface-system>Android Surface System</h2><p>Bn: BinderNative
Bp: BinderProxy
Java上层利用binder调用C++层的bn端，而后C++的bn端再将请求返回给上层</p><p>BpBinder binder的proxy端
BBinder 与BpBinder对应的端</p><pre tabindex=0><code>main_surfaceflinger.cpp	
SurfaceFlinger::publishAndJoinThreadPool();
</code></pre><pre tabindex=0><code>/**--------------------
 * Base class and low-level protocol for a remotable object.
 * You can derive from this class to create an object for which other
 * processes can hold references to it.  Communication between processes
 * (method calls, property get and set) is down through a low-level
 * protocol implemented on top of the transact() API.
 */
class IBinder : public virtual RefBase


/*--------------------
 * This class defines the Binder IPC interface for accessing various
 * SurfaceFlinger features.
 */
class ISurfaceComposer: public IInterface

/*--------------------
 * This class defines the Binder IPC interface for the producer side of
 * a queue of graphics buffers.  It&#39;s used to send graphics data from one
 * component to another.  For example, a class that decodes video for
 * playback might use this to provide frames.  This is typically done
 * indirectly, through Surface.
 *
 * The underlying mechanism is a BufferQueue, which implements
 * BnGraphicBufferProducer.  In normal operation, the producer calls
 * dequeueBuffer() to get an empty buffer, fills it with data, then
 * calls queueBuffer() to make it available to the consumer.
 *
 * This class was previously called ISurfaceTexture.
 */
class IGraphicBufferProducer : public IInterface


/**********************************************************************************
 * CpuConsumer is a BufferQueue consumer endpoint that allows direct CPU
 * access to the underlying gralloc buffers provided by BufferQueue. Multiple
 * buffers may be acquired by it at once, to be used concurrently by the
 * CpuConsumer owner. Sets gralloc usage flags to be software-read-only.
 * This queue is synchronous by default.
 */

class CpuConsumer : public ConsumerBase


// ConsumerBase is a base class for BufferQueue consumer end-points. It
// handles common tasks like management of the connection to the BufferQueue
// and the buffer pool.
class ConsumerBase : public virtual RefBase,
        protected BufferQueue::ConsumerListener 
        

/*
 * This class defines the Binder IPC interface for the producer side of
 * a queue of graphics buffers.  It&#39;s used to send graphics data from one
 * component to another.  For example, a class that decodes video for
 * playback might use this to provide frames.  This is typically done
 * indirectly, through Surface.
 *
 * The underlying mechanism is a BufferQueue, which implements
 * BnGraphicBufferProducer.  In normal operation, the producer calls
 * dequeueBuffer() to get an empty buffer, fills it with data, then
 * calls queueBuffer() to make it available to the consumer.
 *
 * This class was previously called ISurfaceTexture.
 */
class IGraphicBufferProducer : public IInterface

class BufferQueue : public BnGraphicBufferProducer
</code></pre><p>screencap方法的逻辑：</p><pre tabindex=0><code>/frameworks/native/libs/gui/SurfaceComposerClient.cpp
</code></pre><h3 id=screenshotclient的update方法>ScreenshotClient的update方法：</h3><ol><li>getCpuConsumer()：新建一个consumer，</li><li>调用SurfaceFlinger端的captureScreen方法生成截图</li><li>使用1中的consumer消费2中的截图，保存到指针mBuffer指向的内存中</li></ol><h3 id=minicap方法的逻辑>Minicap方法的逻辑：</h3><ol><li><p>根据传递的参数设置截图信息，实际宽高、截图宽高、rotation；设置listener，传递给2中重新封装的FrameProxy</p></li><li><p>应用1中的配置
createVirtualDisplay()：
createDisplay返回一个远程对象用来显示DisplayToken == SurfaceFlinger？
从Cpuconsumer中获取BufferQueue： BnGraphicBufferProducer，设置（图片）大小和（图片）格式。
重新包装了一个listener—— class FrameProxy: public android::ConsumerBase::FrameAvailableListener
consumer设置setFrameAvailableListener。class CpuConsumer : public ConsumerBase</p><p>设置消费所需要用到的各个信息？最终获取到一个DisplayState 所需的内容
android::SurfaceComposerClient::setDisplaySurface(mVirtualDisplay, mBufferQueue);
android::SurfaceComposerClient::setDisplayProjection(mVirtualDisplay, android::DISPLAY_ORIENTATION_0, layerStackRect, visibleRect);
android::SurfaceComposerClient::setDisplayLayerStack(mVirtualDisplay, 0); // default stack</p></li></ol><p>通用逻辑：
使用surfaceComposerClient调用SurfaceFlinger中的具体实现</p><p>/frameworks/native/include/private/gui/LayerState.h
struct DisplayState</p><p>BufferQueue这个类是由应用程序在客户端通过和服务端的Client交互，提交消息给SurfaceFlinger处理时创建的Layer对象时在SurfaceTextureLayer类构造中创建的：
BufferQueue中有一个成员变量BufferSlot mSlots[NUM_BUFFER_SLOTS];即一个BufferQueue实际上最大可以有32个Buffer，即一个应用程序申请的Surface在SF端的Layer可以有32个图像缓存区。而这32个图形缓存区都有上面的mSlots维护着，每个Buffer有以下几种可变的状态，由BufferState mBufferState维护：
分别是FREE,DEQUEUED,QUEUE,ACQUIRED这4个状态，分别是空闲，出列被填充数据，入列代表有了数据，最终将入列后有了图形数据的缓冲区进行渲染。</p><p><a href=http://blog.chinaunix.net/uid-20564848-id-96788.html>android的surfaceflinger原理讲解</a></p><p><a href=http://blog.csdn.net/luoshengyang/article/details/7846923>Android应用程序与SurfaceFlinger服务的关系概述和学习计划</a></p><p><a href=http://blog.csdn.net/gzzaigcnforever/article/details/21892067>Android4.2.2 SurfaceFlinger之图形缓存区申请与分配dequeueBuffer</a></p><p><a href=http://blog.csdn.net/gzzaigcnforever/article/details/49025297>Android5.1中surface和CpuConsumer下生产者和消费者间的处理框架简述</a></p><p><a href=https://source.android.com/devices/graphics/architecture.html>Graphics architecture</a></p><p><a href=https://source.android.com/devices/graphics/>SurfaceFlinger:</a></p><blockquote><p>the system service that consumes the currently visible surfaces and composites them onto the display using information provided by the Window Manager. SurfaceFlinger is the only service that can modify the content of the display. SurfaceFlinger uses OpenGL and the Hardware Composer to compose a group of surfaces.</p></blockquote><p><a href=http://stackoverflow.com/a/21654896/1087122>SurfaceFlinger</a></p><blockquote><p>is an Android system service, responsible for compositing all the application and system surfaces into a single buffer that is finally to be displayed by display controller.</p></blockquote><blockquote><p>Let&rsquo;s zoom in above statement.</p></blockquote><blockquote><p>SurfaceFlinger is a system wide service but it is not directly available to application developer as Sensor or other services can be. Every time you want to update your UI, SurfaceFlinger will kick in. This explains why SurfaceFlinger is a battery drainer.</p></blockquote><blockquote><p>Besides your application surfaces, there are system surfaces, including status bar, navigation bar and, when rotation happens, surfaces created by the system for rotation animation. Most applications have only one active surface - the one of current foreground activity, others have more than one when SurfaceView is used in the view hierarchy or Presentation mode is used.</p></blockquote><blockquote><p>SurfaceFlinger is responsible for COMPOSITING all those surfaces. A common misunderstanding is that SurfaceFinger is for DRAWING. It is not correct. Drawing is the job of OpenGL. The interesting thing is SurfaceFlinger used openGL for compositing as well.</p></blockquote><blockquote><p>The composition result will be put in a system buffer, or native window, which is the source for display controller to fetch data from. This is what you see in the screen.</p></blockquote><h3 id=aidl工具>aidl工具：</h3><p>Example：</p><pre tabindex=0><code>F:\&gt;aidl -IF:\android\sources\08_android-2.2\frameworks\base\core\java\ -IF:\android\sources\08_android-2.2\frameworks\base\graphics\java F:\android\sources\08_android-2.2\frameworks\base\core\java\android\view\IWindowSession.aidl testme.java
F:\&gt;aidl -IF:\android\sources\18_android-4.3_r2.3\frameworks\base\core\java\ -IF:\android\sources\18_android-4.3_r2.3\frameworks\base\graphics\java\ F:\android\sources\18_android-4.3_r2.3\frameworks\base\core\java\android\view\IWindowSession.aidl testme18.java
</code></pre><pre tabindex=0><code>F:\&gt;aidl
INPUT required
usage: aidl OPTIONS INPUT [OUTPUT]
       aidl --preprocess OUTPUT INPUT...

OPTIONS:
   -I&lt;DIR&gt;    search path for import statements.
   -d&lt;FILE&gt;   generate dependency file.
   -a         generate dependency file next to the output file with the name based on the input file.
   -p&lt;FILE&gt;   file created by --preprocess to import.
   -o&lt;FOLDER&gt; base output folder for generated files.
   -b         fail when trying to compile a parcelable.

INPUT:
   An aidl interface file.

OUTPUT:
   The generated interface files.
   If omitted and the -o option is not used, the input filename is used, with the .aidl extension changed to a .java extension.
   If the -o option is used, the generated files will be placed in the base output folder, under their package folder
</code></pre><h3 id=configuration-with-name-debugandroidtestcompile-not-found>Configuration with name &lsquo;debugAndroidTestCompile&rsquo; not found.</h3><p><a href=https://www.jianshu.com/p/82505b608111>caused by protobuf</a></p><p>该问题是gradle 版本和 protobuf 依赖版本不匹配导致的，所以用新的 protobuf 就可以了</p><pre tabindex=0><code>    dependencies {
        ...
        classpath &#39;com.google.protobuf:protobuf-gradle-plugin:0.8.5&#39;
        ...
    }
</code></pre><div class="prev-next-post pure-g"><div class=pure-u-1-24 style=text-align:left><a href=http://gebitang.com/post/what/weekly-2018/><i class="fa fa-chevron-left"></i></a></div><div class=pure-u-10-24><nav class=prev><a href=http://gebitang.com/post/what/weekly-2018/>Weekly 2018</a></nav></div><div class=pure-u-2-24>&nbsp;</div><div class=pure-u-10-24><nav class=next><a href=http://gebitang.com/post/what/no04-fitness-and-meditation/>Fitness and Meditation</a></nav></div><div class=pure-u-1-24 style=text-align:right><a href=http://gebitang.com/post/what/no04-fitness-and-meditation/><i class="fa fa-chevron-right"></i></a></div></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="gebitang",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><script src=http://gebitang.com/js/ui.js></script>
<script src=http://gebitang.com/js/menus.js></script>
<script>window.location.hostname!="localhost"&&(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-34303694-1","auto"),ga("send","pageview"))</script><button onclick=topFunction() id=myBtn title="Go to top">Top</button></body></html>